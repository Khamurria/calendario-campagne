<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calendario Campagne Social - Visualizzazione</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100">
    <!-- HEADER SEMPLIFICATO -->
    <header class="flex justify-between items-center p-4 bg-white shadow">
      <div class="flex items-center">
        <img
          src="img/regione-lombardia.jpg"
          alt="Regione Lombardia"
          class="h-12 w-auto object-contain mr-4"
        />
        <h1 class="text-2xl font-bold">Calendario campagne social</h1>
      </div>
    </header>
    <!-- LEGENDA -->
    <section class="p-4 bg-white mt-4 shadow flex flex-wrap items-center gap-4">
      <div class="flex items-center space-x-2">
        <span class="w-3 h-3 bg-blue-600 rounded-full"></span>
        <span class="text-sm">Facebook</span>
      </div>
      <div class="flex items-center space-x-2">
        <span class="w-3 h-3 bg-pink-500 rounded-full"></span>
        <span class="text-sm">Instagram</span>
      </div>
      <div class="flex items-center space-x-2">
        <span class="w-3 h-3 bg-red-500 rounded-full"></span>
        <span class="text-sm">TikTok</span>
      </div>
      <div class="flex items-center space-x-2">
        <span class="w-3 h-3 bg-blue-800 rounded-full"></span>
        <span class="text-sm">Linkedin</span>
      </div>
      <div class="flex items-center space-x-2">
        <span class="w-3 h-3 bg-sky-500 rounded-full"></span>
        <span class="text-sm">Twitter</span>
      </div>
      <div class="flex items-center space-x-2 border-l pl-4">
        <svg
          xmlns="https://www.w3.org/2000/svg"
          class="w-4 h-4 fill-black"
          viewBox="0 0 24 24"
        >
          <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" />
        </svg>
        <span class="text-sm">Campagna in dark</span>
      </div>
    </section>
    <!-- CONTENUTO PRINCIPALE -->
    <main class="p-4 space-y-6">
      <!-- TABELLA IN SOLA LETTURA -->
      <section class="bg-white p-4 shadow rounded">
        <h2 class="text-lg font-bold mb-3">Elenco Post Sponsorizzati</h2>
        <div class="overflow-x-auto">
          <table class="min-w-full table-auto">
            <thead>
              <tr class="bg-gray-200">
                <th class="px-2 py-1 border text-sm text-center">Titolo</th>
                <th class="px-2 py-1 border text-sm text-center">Anteprima</th>
                <th class="px-2 py-1 border text-sm text-center">Periodo</th>
                <th class="px-2 py-1 border text-sm text-center">Tipo</th>
                <th class="px-2 py-1 border text-sm text-center">Canale</th>
                <th class="px-2 py-1 border text-sm text-center">Dark</th>
                <th class="px-2 py-1 border text-sm text-center">Link</th>
              </tr>
            </thead>
            <tbody id="campaign-table-body">
              <tr id="no-campaigns">
                <td colspan="7" class="text-center py-4 text-sm">
                  Nessuna sponsorizzata inserita
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- CALENDARIO -->
      <section class="bg-white p-4 shadow rounded">
        <div class="flex justify-between items-center mb-3">
          <button
            id="prev-month"
            class="text-gray-800 hover:text-gray-900 text-lg font-bold"
          >
            &lt;
          </button>
          <h2 id="calendar-title" class="text-2xl font-bold">Gennaio 2025</h2>
          <button
            id="next-month"
            class="text-gray-800 hover:text-gray-900 text-lg font-bold"
          >
            &gt;
          </button>
        </div>
        <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
      </section>
    </main>
    <script>
      let campaigns = [];
      let currentMonth = 0;
      let currentYear = 2025;

      // Funzioni di utilit√†
      function formatDate(dateStr) {
        const d = new Date(dateStr);
        return d.toLocaleDateString('it-IT');
      }

      // Render tabella
      function renderCampaignTable() {
        const tbody = document.getElementById('campaign-table-body');
        tbody.innerHTML = '';
        if (campaigns.length === 0) {
          tbody.innerHTML =
            '<tr id="no-campaigns"><td colspan="7" class="text-center py-4 text-sm">Nessuna sponsorizzata inserita</td></tr>';
          return;
        }
        campaigns.forEach((campaign) => {
          const imageContent = campaign.image
            ? `<img src="${campaign.image}" class="w-16 h-16 object-cover mx-auto" />`
            : '';
          const darkContent = campaign.dark
            ? `<svg xmlns="https://www.w3.org/2000/svg" class="h-4 w-4 inline fill-black mx-auto" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>`
            : '';
          const linkContent = campaign.link
            ? `<a href="${campaign.link}" target="_blank" class="text-blue-500 underline text-sm">Link</a>`
            : '';
          const tr = document.createElement('tr');
          tr.className = 'border-t';
          tr.innerHTML = `
            <td class="px-2 py-1 border text-sm text-center break-words">${campaign.title}</td>
            <td class="px-2 py-1 border text-sm">${imageContent}</td>
            <td class="px-2 py-1 border text-sm text-center">${formatDate(campaign.start)} - ${formatDate(campaign.end)}</td>
            <td class="px-2 py-1 border text-sm text-center break-words">${campaign.type}</td>
            <td class="px-2 py-1 border text-sm text-center">${campaign.channel}</td>
            <td class="px-2 py-1 border text-sm text-center">${darkContent}</td>
            <td class="px-2 py-1 border text-sm text-center">${linkContent}</td>
          `;
          tbody.appendChild(tr);
        });
      }

      // Render calendario
      function renderCalendar(year, month) {
        const calendarGrid = document.getElementById('calendar-grid');
        calendarGrid.innerHTML = '';
        const monthNames = [
          'Gennaio',
          'Febbraio',
          'Marzo',
          'Aprile',
          'Maggio',
          'Giugno',
          'Luglio',
          'Agosto',
          'Settembre',
          'Ottobre',
          'Novembre',
          'Dicembre'
        ];
        document.getElementById('calendar-title').textContent =
          `${monthNames[month]} ${year}`;
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        let offset = firstDay === 0 ? 6 : firstDay - 1;
        for (let i = 0; i < offset; i++) {
          calendarGrid.appendChild(document.createElement('div'));
        }
        for (let day = 1; day <= daysInMonth; day++) {
          const cell = document.createElement('div');
          cell.className =
            'border p-1 relative min-h-[6rem] flex flex-col items-center justify-start';
          cell.innerHTML = `<div class="text-sm font-bold">${day}</div>`;
          campaigns.forEach((campaign) => {
            const startDate = new Date(campaign.start);
            const endDate = new Date(campaign.end);
            const currentDate = new Date(year, month, day);
            if (currentDate >= startDate && currentDate <= endDate) {
              const stripe = document.createElement('div');
              stripe.className =
                'text-xs text-white rounded p-0.5 mt-1 w-full px-1';
              const colorMap = {
                Facebook: 'bg-blue-600',
                Instagram: 'bg-pink-500',
                TikTok: 'bg-red-500',
                Linkedin: 'bg-blue-800',
                Twitter: 'bg-sky-500'
              };
              stripe.classList.add(colorMap[campaign.channel]);
              stripe.innerHTML = `${campaign.title} - ${campaign.type} ${
                campaign.dark
                  ? '<svg xmlns="https://www.w3.org/2000/svg" class="w-3 h-3 inline fill-black mx-auto" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>'
                  : ''
              }`;
              if (campaign.link) {
                stripe.style.cursor = 'pointer';
                stripe.addEventListener('click', () =>
                  window.open(campaign.link, '_blank')
                );
              }
              cell.appendChild(stripe);
            }
          });
          calendarGrid.appendChild(cell);
        }
      }

      // Caricamento iniziale
      document.addEventListener('DOMContentLoaded', async () => {
        const githubToken = localStorage.getItem('githubToken');
        const gistId = localStorage.getItem('gistId');
        if (githubToken && gistId) {
          try {
            const res = await fetch(`https://api.github.com/gists/${gistId}`, {
              headers: {
                Authorization: 'token ' + githubToken
              }
            });
            if (res.ok) {
              const data = await res.json();
              if (data.files && data.files['campaigns.json']) {
                campaigns = JSON.parse(data.files['campaigns.json'].content);
              }
            }
          } catch (error) {
            console.error('Errore nel caricamento dei dati:', error);
          }
        }
        renderCampaignTable();
        renderCalendar(currentYear, currentMonth);

        // Gestione navigazione calendario
        document.getElementById('prev-month').addEventListener('click', () => {
          currentMonth = currentMonth === 0 ? 11 : currentMonth - 1;
          currentYear = currentMonth === 11 ? currentYear - 1 : currentYear;
          renderCalendar(currentYear, currentMonth);
        });
        document.getElementById('next-month').addEventListener('click', () => {
          currentMonth = currentMonth === 11 ? 0 : currentMonth + 1;
          currentYear = currentMonth === 0 ? currentYear + 1 : currentYear;
          renderCalendar(currentYear, currentMonth);
        });
      });
    </script>
  </body>
</html>

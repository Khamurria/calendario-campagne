<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario Campagne - Visualizzazione</title>
    <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-gray-100">
    <!-- Header con logo e titolo -->
    <header class="bg-white shadow-sm">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <img src="logo.png" alt="Logo" class="h-10">
                    <h1 class="text-2xl font-bold text-gray-900">Calendario Campagne</h1>
                </div>
                <button onclick="printCalendar()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center">
                    <i class="fas fa-print mr-2"></i>
                    Stampa Calendario
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <!-- Navigazione mesi -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex justify-between items-center mb-6">
                <button onclick="changeMonth(-1)" class="text-gray-600 hover:text-gray-900">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <h2 class="text-xl font-semibold text-gray-900" id="currentMonth"></h2>
                <button onclick="changeMonth(1)" class="text-gray-600 hover:text-gray-900">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>

            <!-- Legenda canali -->
            <div id="channelsLegend" class="flex flex-wrap gap-4 mb-6"></div>

            <!-- Calendario -->
            <div id="calendar" class="grid grid-cols-7 gap-2"></div>
        </div>

        <!-- Lista campagne -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-6">Campagne del Mese</h2>
            <div id="campaignsList"></div>
        </div>
    </main>

    <script>
        let campaigns = [];
        let currentDate = new Date();

        // Definizione dei colori per i canali social
        const channelColors = {
            Facebook: '#1877F2',     // Blu Facebook
            Instagram: '#E4405F',    // Rosa Instagram
            LinkedIn: '#0A66C2',     // Blu LinkedIn
            YouTube: '#FF0000',      // Rosso YouTube
            TikTok: '#000000',       // Nero TikTok
            Pinterest: '#E60023',    // Rosso Pinterest
            Twitter: '#1DA1F2',      // Blu Twitter
            Blog: '#FF6B00',         // Arancione
            Newsletter: '#6B3FA0',   // Viola
            'E-commerce': '#00C853', // Verde
            Marketplace: '#FFD600',  // Giallo
            Other: '#78909C'         // Grigio blu
        };

        function getChannelColorWithOpacity(channel, opacity = 1) {
            const color = channelColors[channel] || channelColors.Other;
            if (opacity === 1) return color;
            const r = parseInt(color.slice(1,3), 16);
            const g = parseInt(color.slice(3,5), 16);
            const b = parseInt(color.slice(5,7), 16);
            return `rgba(${r}, ${g}, ${b}, ${opacity})`;
        }

        function renderChannelsLegend() {
            const legendContainer = document.createElement('div');
            legendContainer.className = 'mb-6 flex flex-wrap gap-4';
            
            Object.entries(channelColors).forEach(([channel, color]) => {
                const item = document.createElement('div');
                item.className = 'flex items-center space-x-2';
                item.innerHTML = `
                    <div class="w-3 h-3 rounded-full" style="background-color: ${color}"></div>
                    <span class="text-sm text-gray-700">${channel}</span>
                `;
                legendContainer.appendChild(item);
            });

            // Inserisci la legenda prima del calendario
            const calendar = document.getElementById('calendar');
            calendar.parentElement.insertBefore(legendContainer, calendar);
        }

        function renderCalendar() {
            const calendar = document.getElementById('calendar');
            const monthTitle = document.getElementById('currentMonth');
            
            const monthNames = [
                'Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'
            ];
            const dayNames = ['Dom', 'Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab'];
            
            monthTitle.textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
            calendar.innerHTML = '';

            // Aggiungi intestazioni giorni
            dayNames.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'text-center font-medium text-gray-700 py-2';
                dayHeader.textContent = day;
                calendar.appendChild(dayHeader);
            });

            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            
            // Celle vuote iniziali
            for (let i = 0; i < firstDay.getDay(); i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'p-2 border border-gray-200 rounded bg-gray-50';
                calendar.appendChild(emptyCell);
            }

            // Giorni del mese
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const cell = document.createElement('div');
                cell.className = 'p-2 border border-gray-200 rounded min-h-[100px] bg-white';
                
                const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const campaignsForDay = campaigns.filter(c => 
                    dateStr >= c.startDate && dateStr <= c.endDate
                );

                cell.innerHTML = `
                    <div class="font-medium text-gray-700 mb-1">${day}</div>
                    <div class="space-y-1">
                        ${campaignsForDay.map(campaign => `
                            <div class="px-2 py-1 rounded text-xs font-medium truncate"
                                 style="background-color: ${getChannelColorWithOpacity(campaign.channel, 0.2)};
                                        color: ${channelColors[campaign.channel]};
                                        border-left: 3px solid ${channelColors[campaign.channel]}">
                                ${campaign.title}
                            </div>
                        `).join('')}
                    </div>
                `;
                
                calendar.appendChild(cell);
            }
        }

        function renderCampaigns() {
            const list = document.getElementById('campaignsList');
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();
            
            const monthCampaigns = campaigns.filter(campaign => {
                const startDate = new Date(campaign.startDate);
                const endDate = new Date(campaign.endDate);
                return (startDate.getMonth() === currentMonth && startDate.getFullYear() === currentYear) ||
                       (endDate.getMonth() === currentMonth && endDate.getFullYear() === currentYear);
            });

            // ... [resto del codice per il rendering delle campagne] ...
        }

        async function loadSharedCalendar() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const gistId = urlParams.get('gist');
                
                if (!gistId) {
                    throw new Error('Nessun calendario specificato');
                }

                const response = await axios.get(`https://api.github.com/gists/${gistId}`);
                if (response.status === 200 && response.data.files['calendar_data.json']) {
                    const content = JSON.parse(response.data.files['calendar_data.json'].content);
                    campaigns = content.campaigns || [];
                    renderChannelsLegend();
                    renderCalendar();
                    renderCampaigns();
                }
            } catch (error) {
                console.error('Errore nel caricamento del calendario:', error);
                document.body.innerHTML = `
                    <div class="flex items-center justify-center min-h-screen">
                        <div class="text-center">
                            <h1 class="text-2xl font-bold text-red-600 mb-4">Errore</h1>
                            <p class="text-gray-600">Impossibile caricare il calendario condiviso.</p>
                        </div>
                    </div>
                `;
            }
        }

        // Funzione per cambiare mese
        function changeMonth(delta) {
            currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + delta, 1);
            renderCalendar();
            renderCampaigns();
        }

        // Funzione per stampare
        function printCalendar() {
            window.print();
        }

        // Stili per la stampa
        const printStyles = document.createElement('style');
        printStyles.textContent = `
            @media print {
                body { background: white; }
                header button, 
                .no-print { display: none !important; }
                #calendar { break-inside: avoid; }
                .shadow-lg { box-shadow: none !important; }
                .campaign-event { break-inside: avoid; }
            }
        `;
        document.head.appendChild(printStyles);

        // Carica il calendario quando la pagina si apre
        document.addEventListener('DOMContentLoaded', loadSharedCalendar);
    </script>
</body>
</html>
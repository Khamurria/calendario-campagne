<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CONDORSPACE V2.11.3 - Flusso Integrato</title> <!-- Versione aggiornata -->
    <!-- Font VT323 per stile retro/terminal -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=VT323&display=swap">

    <!-- === FINE BLOCCO 1 === -->
    <!-- === INSERISCI QUI IL BLOCCO 2 (CSS Styles) === -->
    <!-- === INIZIO BLOCCO 2 (CSS Styles) === -->
    <style>
        /* Stili generali con font VT323 come base */
        body { margin: 0; padding: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: #050510; font-family: 'VT323', monospace; color: #e0e0ff; overflow: hidden; }
        #mainLayout { display: none; /* Inizia nascosto */ align-items: flex-start; background-color: #0c0c18; border-radius: 8px; box-shadow: 0 0 25px rgba(0, 180, 255, 0.2); padding: 10px; opacity: 0; transition: opacity 0.5s ease-in; position: relative; z-index: 1; pointer-events: none; }
        #mainLayout.visible { display: flex; opacity: 1; pointer-events: auto; }

        /* High Score Container & Title Header */
        #highScoreContainer { width: 180px; height: 640px; padding: 0; margin-right: 15px; background-color: rgba(26, 26, 42, 0.8); border: 1px solid #333; border-radius: 5px; box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.6); display: flex; flex-direction: column; color: #c0c0dd; }
        #titleHeader { padding: 10px 15px 5px 15px; text-align: center; border-bottom: 1px solid #445566; background-color: rgba(0,0,0,0.2); flex-shrink: 0; }
        #titleHeader canvas#titleLogoCanvas { margin-bottom: 5px; width: 80%; height: auto; max-width: 120px; display: block; margin-left: auto; margin-right: auto; image-rendering: pixelated; }
        #titleHeader h1 { font-size: 1.3em; margin: 0 0 2px 0; color: #49daff; text-shadow: 0 0 8px #49daff; letter-spacing: 2px; text-transform: uppercase; }
        #titleHeader h2 { font-size: 0.8em; margin: 0 0 8px 0; color: #a0e0ff; font-weight: normal; letter-spacing: 1px; }
        #highScoreContent { padding: 10px 15px; flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        #highScoreContent h3 { margin-top: 5px; margin-bottom: 15px; color: #aaccff; text-align: center; border-bottom: 1px solid #445566; padding-bottom: 8px; font-size: 1.1em; letter-spacing: 1px; }
        #highScoreList { list-style: none; padding: 0; margin: 0 0 20px 0; font-size: 14px; flex-grow: 1; overflow-y: auto; scrollbar-width: thin; scrollbar-color: #445566 #0c0c18; }
        #highScoreList::-webkit-scrollbar { width: 6px; }
        #highScoreList::-webkit-scrollbar-track { background: #0c0c18; }
        #highScoreList::-webkit-scrollbar-thumb { background-color: #445566; border-radius: 3px; }
        #highScoreList li { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; padding: 3px 5px; border-radius: 3px; background-color: rgba(0,0,0,0.1); border-left: 3px solid transparent; transition: background-color 0.3s, border-left 0.3s; }
        #highScoreList li:hover { background-color: rgba(255, 255, 255, 0.15); border-left-color: #49daff; }
        #highScoreList li span:first-child { font-weight: normal; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100px; line-height: 1.2; }
        #highScoreList li span:first-child span { font-size: 0.9em; vertical-align: middle; margin-left: 4px; }
        #highScoreList li span:nth-child(2) { color: #ffff88; min-width: 40px; text-align: right; font-weight: bold; }
        .instructions { margin-top: auto; padding: 15px 0 5px 0; border-top: 1px solid #445566; font-size: 13px; color: #bbddff; text-align: left; text-shadow: 0 0 4px rgba(100, 180, 255, 0.8); flex-shrink: 0; line-height: 1.4; }

        /* Canvas & Game Area */
        #canvasWrapper { position: relative; width: 480px; height: 640px; overflow: hidden; margin: 0; padding: 0; }
        #gameCanvas { border: 1px solid #303050; box-shadow: 0 0 15px rgba(0, 150, 255, 0.3); display: block; background-color: #0a0a1a; width: 100%; height: 100%; cursor: default; transition: border-color 0.3s ease; image-rendering: pixelated; }
        #gameCanvas:focus { outline: none; border-color: #49daff; }
        #uiSidebar { width: 180px; padding: 10px 15px; margin-left: 15px; background-color: rgba(26, 26, 42, 0.8); border: 1px solid #333; border-radius: 5px; box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.6); height: 640px; display: flex; flex-direction: column; }
        #uiSidebar h3 { margin-top: 5px; margin-bottom: 15px; color: #aaccff; text-align: center; border-bottom: 1px solid #445566; padding-bottom: 8px; font-size: 1.1em; letter-spacing: 1px; }
        #uiSidebar p { margin: 8px 0; font-size: 15px; color: #c0c0dd; display: flex; justify-content: space-between; align-items: center; }
        #uiSidebar span { font-weight: normal; color: #fff; background-color: rgba(0, 0, 0, 0.2); padding: 1px 4px; border-radius: 3px; min-width: 40px; text-align: right; }
        .shieldActiveUI { color: #80ffff !important; font-weight: bold; text-shadow: 0 0 5px #80ffff; }
        #healthBarContainer { width: 100%; height: 10px; background-color: rgba(255,0,0,0.3); border: 1px solid #800; border-radius: 2px; margin-top: 2px; overflow: hidden; }
        #healthBar { height: 100%; width: 100%; background-color: #40ff40; border-radius: 1px; transition: width 0.2s ease-out, background-color 0.2s ease; }
        #healthValue { font-size: 0.9em; margin-left: 5px; font-weight: bold; }

        /* Box Nome Cadetto */
        #cadetNameContainer { margin-top: 15px; margin-bottom: 15px; text-align: center; padding: 8px 0; border-top: 1px solid #445566; border-bottom: 1px solid #445566; background-color: rgba(0,0,0,0.15); }
        #cadetNameContainer div:first-child { color: #aaccff; font-size: 0.9em; margin-bottom: 3px; text-transform: uppercase; letter-spacing: 1px;}
        #cadetNameDisplay { color: #ffaa44; font-weight: bold; font-size: 1.1em; text-shadow: 0 0 4px #ffaa44;}
        #cadetNameContainer div:last-child { color: #aaccff; font-size: 0.8em; margin-top: 3px; font-style: italic;}

        /* Boss Health */
        #bossHealthBarContainer { position: absolute; top: 10px; left: 10%; width: 80%; height: 18px; background-color: rgba(100, 0, 0, 0.7); border: 2px solid #ff8888; border-radius: 4px; z-index: 60; display: none; overflow: hidden; box-shadow: 0 0 10px rgba(255, 0, 0, 0.5); }
        #bossHealthBar { height: 100%; width: 100%; background: linear-gradient(to right, #ff4444, #ff8888); border-radius: 2px; transition: width 0.3s ease-out; }
        #bossHealthText { position: absolute; top: 0; left: 0; width: 100%; text-align: center; font-size: 12px; font-weight: bold; color: #fff; line-height: 18px; text-shadow: 1px 1px 2px black; letter-spacing: 1px; }

        /* Overlays & Buttons */
        .overlayButton { padding: 12px 25px; font-size: 1.1em; cursor: pointer; color: #fff; border-radius: 5px; text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5); transition: all .2s ease; margin-top: 10px; text-transform: uppercase; letter-spacing: 1px; }
        #startButton { display: none; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); background-color: #2a9fd8; border: 2px solid #1c6d9a; box-shadow: 0 0 15px rgba(40, 160, 220, 0.7); z-index: 20; }
        #startButton:hover:not(:disabled) { background-color: #3ab0e8; box-shadow: 0 0 20px rgba(60, 180, 240, 0.9); transform: translate(-50%, -50%) scale(1.05); }
        #startButton:disabled { background-color: #555; border-color: #444; cursor: wait; opacity: 0.7; }

        #gameOverOverlay { display: none; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); width: 380px; padding: 25px; background-color: rgba(10, 10, 30, 0.95); border: 2px solid #667799; border-radius: 10px; text-align: center; box-shadow: 0 0 25px rgba(100, 120, 180, 0.5); z-index: 30; flex-direction: column; align-items: center; transition: border-color 0.5s ease, box-shadow 0.5s ease; }
        #gameOverOverlay.victory { border-color: #ffd700; box-shadow: 0 0 25px rgba(255, 215, 0, 0.6); }
        #gameOverOverlay h2 { margin-top: 0; margin-bottom: 15px; font-size: 2.3em; letter-spacing: 2px; }
        #gameOverOverlay:not(.victory) h2 { color: #ff6666; text-shadow: 0 0 10px rgba(255, 50, 50, 0.7); }
        #gameOverOverlay.victory h2 { color: #ffd700; text-shadow: 0 0 10px rgba(255, 215, 0, 0.8); }
        #gameOverOverlay p { font-size: 1.1em; color: #ddddff; margin-bottom: 15px; }
        #finalScore { font-weight: bold; color: #ffff88; font-size: 1.2em; }
        #finalScore span { display: inline-block; margin-left: 5px; } /* For trophy */
        #highScoreEntry { display: none; width: 85%; margin-top: 15px; }
        #highScoreEntry label { display: block; margin-bottom: 5px; font-size: 1em; color: #aaccff; }
        #highScoreEntry label span { display: inline-block; margin-left: 5px; } /* For trophy in label */
        #playerNameInput { width: calc(100% - 22px); padding: 9px 10px; font-size: 1em; border: 1px solid #667799; background-color: #1a1a3a; color: #e0e0ff; border-radius: 4px; text-align: center; margin-top: 5px; font-family: 'VT323', monospace; }
        #saveScoreButton { background-color: #f0ad4e; border: 2px solid #eea236; box-shadow: 0 0 15px rgba(240, 173, 78, 0.6); }
        #saveScoreButton:hover { background-color: #f3bd72; box-shadow: 0 0 20px rgba(240, 173, 78, 0.8); transform: scale(1.05); }
        #restartButton { background-color: #5cb85c; border: 2px solid #4cae4c; box-shadow: 0 0 15px rgba(92, 184, 92, 0.6); }
        #restartButton:hover { background-color: #6cd96c; box-shadow: 0 0 20px rgba(110, 200, 110, 0.8); transform: scale(1.05); }

        #pauseOverlay { position: absolute; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 20, 0.7); z-index: 40; display: none; justify-content: center; align-items: center; text-align: center; font-size: 2.5em; color: #aaccff; text-shadow: 0 0 10px #00ffff; pointer-events: none; letter-spacing: 3px; }
        #pauseOverlay.visible { display: flex; }
        #uiMessageDisplay { position: absolute; top: 40%; left: 50%; transform: translateX(-50%); background-color: rgba(0, 0, 0, 0.75); color: #ff6666; padding: 10px 20px; border-radius: 5px; font-size: 1.3em; font-weight: normal; /* Rimosso bold */ z-index: 50; text-align: center; text-shadow: 1px 1px 2px black; opacity: 0; transition: opacity 0.3s ease-out; pointer-events: none; }
        #uiMessageDisplay.visible { opacity: 1; }

        /* --- Intro Styles --- */
        #introOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #000; z-index: 100; display: none; justify-content: center; align-items: center; overflow: hidden; perspective: 400px; font-family: 'VT323', monospace; opacity: 0; transition: opacity 1s ease-out; }
        #introOverlay.visible { display: flex; opacity: 1; }
        #introOverlay.hidden { opacity: 0; pointer-events: none; }
        #introSequence { position: relative; width: 100%; height: 100%; }
        #introLogoContainer { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #49daff; opacity: 0; animation: fadeInLogo 5s ease-out forwards; z-index: 102; }
        #introLogoCanvas { display: block; margin: 0 auto 10px auto; width: 150px; height: 75px; image-rendering: pixelated; }
        #introGameTitle { font-size: 3.5em; margin: 0; text-shadow: 0 0 15px #49daff, 0 0 5px #fff; letter-spacing: 4px; text-transform: uppercase; }
        #introGameSubtitle { font-size: 1.2em; margin: 5px 0 0 0; color: #a0e0ff; text-shadow: 0 0 5px #a0e0ff; letter-spacing: 2px; text-transform: uppercase; }
        @keyframes fadeInLogo { 0%{opacity:0;transform:translate(-50%,-50%) scale(.8)} 20%{opacity:1;transform:translate(-50%,-50%) scale(1)} 80%{opacity:1;transform:translate(-50%,-50%) scale(1)} 100%{opacity:0;transform:translate(-50%,-50%) scale(1.2)} }
        #crawlContainer { position: absolute; bottom: 0; height: 200%; width: 90%; max-width: 800px; left: 50%; transform-origin: 50% 100%; transform: translateX(-50%) rotateX(25deg); animation: crawl 60s linear 5s forwards; opacity: 0; z-index: 101; }
        #crawlContent { color: #a0e0ff; font-size: 1.8em; line-height: 1.45em; text-align: left; text-shadow: 0 0 8px #49daff; letter-spacing: 0.5px; }
        #crawlContent .subtitle { font-size: 1.2em; text-align: center; margin-bottom: 1.5em; color: #fff; text-shadow: 0 0 10px #a0e0ff; }
        #crawlContent p { margin-bottom: 1.2em; position: relative; padding-left: 30px; }
        #crawlContent p:before { content: ">"; position: absolute; left: 0; color: #49daff; }
        @keyframes crawl { 0%{bottom:-100%;opacity:1} 100%{bottom:110%;opacity:1} }
        #skipIntroButton { position: absolute; bottom: 20px; right: 20px; padding: 10px 20px; font-size: 14px; background-color: rgba(0, 0, 0, 0.7); color: #49daff; border: 1px solid #49daff; border-radius: 5px; cursor: pointer; z-index: 103; opacity: 0.7; transition: opacity 0.3s, background-color 0.3s; }
        #skipIntroButton:hover { opacity: 1; background-color: rgba(255, 255, 255, 0.2); color: #eee; }

        /* Effetto CRT */
        .crt-effect { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06)); background-size: 100% 2px, 3px 100%; pointer-events: none; z-index: 104; }
        /* Terminal Header/Footer Intro */
        #terminal-header, #terminal-footer { position: absolute; left: 10px; font-size: 1em; color: #49daff; text-shadow: 0 0 5px #49daff; padding: 5px; z-index: 102; text-align: left; opacity: 0; animation: fadeIn 2s ease-in forwards 2s; max-width: 50%; }
        #terminal-header { top: 10px; } #terminal-footer { bottom: 10px; }
        /* Animazioni Flicker, FadeIn, Blink */
        @keyframes textShadowFlicker{0%,20%,50%,70%,100%{text-shadow:0 0 5px rgba(73,218,255,.5)}10%,60%,90%{text-shadow:0 0 7px rgba(73,218,255,.7)}30%{text-shadow:0 0 8px rgba(73,218,255,.8)}40%,80%{text-shadow:0 0 6px rgba(73,218,255,.6)}}
        .flicker-text { animation: textShadowFlicker 5s infinite; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes blink { 0%,49%{opacity:1} 50%,100%{opacity:0} }
        .cursor { display: inline-block; width: 10px; height: 20px; background-color: #49daff; margin-left: 5px; animation: blink 1s infinite; vertical-align: middle; }

        /* --- Schermata Registrazione Cadetto (NUOVI STILI) --- */
        #cadetRegistrationScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: none; justify-content: center; align-items: center; background: rgba(0, 0, 0, 0.95); /* Più scuro */ z-index: 95; opacity: 0; transition: opacity 0.5s ease-in-out; pointer-events: none; }
        #cadetRegistrationScreen.active { display: flex; opacity: 1; pointer-events: auto; }
        #cadetRegistrationContainer { /* Stili gestiti dentro renderCadetRegistration() per coerenza */ background: transparent; /* Rende trasparente il contenitore HTML base */ padding: 0; border: none; box-shadow: none; width: auto; /* Lascia che il contenuto interno definisca la larghezza */ }
        /* Stili specifici per gli elementi generati da renderCadetRegistration */
        #cadetRegistrationContainer > div { /* Stile per il div interno aggiunto da JS */ display: flex; flex-direction: column; align-items: center; background: #0f0f1e; padding: 20px; border-radius: 10px; border: 1px solid #49daff; box-shadow: 0 0 30px rgba(73, 218, 255, 0.4); }
        #cadetCanvas { margin-bottom: 20px; max-width: 100%; height: auto; border-radius: 5px; }
        #cadetNameInput { /* Stili già definiti nello JS di renderCadetRegistration */ flex: 1; padding: 10px; background: #0a0a2a; color: #49daff; border: 2px solid #49daff; border-radius: 4px; font-size: 16px; font-family: 'VT323', monospace; }
        #submitCadetButton { /* Stili già definiti nello JS di renderCadetRegistration */ margin-left: 10px; padding: 10px 20px; background: #49daff; color: #000; border: none; border-radius: 4px; font-weight: normal; /* Rimosso bold */ cursor: pointer; text-transform: uppercase; letter-spacing: 1px; }
        #submitCadetButton:hover:not(:disabled) { background-color: #a0e0ff; box-shadow: 0 0 15px #49daff; }
        #submitCadetButton:disabled { background: #274b5d; color: #aaa; cursor: not-allowed; opacity: 0.7; }

    </style>
</head>
<body> <!-- Tag body aperto -->

    <!-- === FINE BLOCCO 2 === -->
    <!-- === INSERISCI QUI IL BLOCCO 3 (HTML Body Content) === -->
    <!-- === INIZIO BLOCCO 3 (HTML Body Content) === -->

    <!-- Overlay Intro Terminale (Nascosto inizialmente, mostrato da JS) -->
    <div id="introOverlay">
        <!-- Header e Footer stile terminale -->
        <div id="terminal-header" class="flicker-text">
            DEMAND GALATTICO DEFCOM v3.7.2<br>
            RAM: 16384Kb ONLINE<br>
            RAPTOR-X MISSION BRIEFING
        </div>
        <div id="terminal-footer" class="flicker-text">
            ENCRYPTION: ENABLED<br>
            CMDR CONDOR AUTH: OK
        </div>

        <!-- Contenuto animato dell'intro -->
        <div id="introSequence">
            <!-- Logo e Titolo gioco -->
            <div id="introLogoContainer">
                <canvas id="introLogoCanvas" width="150" height="75"></canvas> <!-- Canvas per logo Raptor-X -->
                <h1 id="introGameTitle" class="flicker-text">CONDORSPACE</h1>
                <h2 id="introGameSubtitle" class="flicker-text">NETHEX CONTRO IL DEMAND GALATTICO</h2>
            </div>
            <!-- Testo scorrevole -->
            <div id="crawlContainer">
                <div id="crawlContent">
                    <!-- Storia Originale Ripristinata -->
                    <div class="subtitle flicker-text">LA MINACCIA DELL'IMPERATRICE CIVELLO</div>
                    <p>INIT BRIEFING SEQUENCE...</p>
                    <p>È un'era di prosperità per l'umanità. Grazie al Demand Galattico, una vasta rete di cooperazione interplanetaria, le colonie terrestri fioriscono tra le stelle.</p>
                    <p>WARNING: ENEMY INTEL DETECTED</p>
                    <p>Sul pianeta Nethex, la sanguinaria Imperatrice Civello governa con pugno di ferro. Il suo unico scopo è vedere distrutto il Demand Galattico e l'intera civiltà terrestre.</p>
                    <p>Per compiere la sua missione di distruzione, l'Imperatrice ha inviato il temibile Comandante Scuderi con le sue truppe d'élite di Backoffice, pronte ad annientare la flotta del Demand.</p>
                    <p>CADET PROFILE LOADING...</p>
                    <p>Tu sei un semplice cadetto del Demand Galattico, assegnato alla guida dell'intercettore sperimentale Raptor-X dall'Ammiraglio Condor, valoroso baluardo della speranza della Terra.</p>
                    <p>MISSION DIRECTIVE FOLLOWS:</p>
                    <p>La tua missione è affrontare le truppe Backoffice, penetrare le loro difese e fermare il Comandante Scuderi prima che sia troppo tardi.</p>
                    <p>MISSION STATUS: IN PROGRESS</p>
                    <p>RAPTOR-X CONTROLS INITIALIZED</p>
                    <p>GOOD LUCK, CADET<span class="cursor"></span></p>
                </div>
            </div>
        </div>
        <!-- Pulsante per saltare l'intro -->
        <button id="skipIntroButton">Salta Intro (Spazio)</button>
        <!-- Effetto CRT overlay -->
        <div class="crt-effect"></div>
    </div>

    <!-- Schermata Registrazione Cadetto (Contenitore vuoto, popolato da JS) -->
    <div id="cadetRegistrationScreen">
        <div id="cadetRegistrationContainer">
             <!-- Il contenuto (canvas, input, button) viene aggiunto qui da renderCadetRegistration() -->
        </div>
    </div>

    <!-- Layout Principale del Gioco (Nascosto inizialmente) -->
    <div id="mainLayout">
        <!-- Sidebar Sinistra: Titolo e High Scores -->
        <div id="highScoreContainer">
            <div id="titleHeader">
                 <canvas id="titleLogoCanvas" width="120" height="60"></canvas> <!-- Logo Raptor-X nel titolo -->
                 <h1>CONDORSPACE</h1>
                 <h2>NETHEX CONTRO IL DEMAND GALATTICO</h2>
            </div>
            <div id="highScoreContent">
                 <h3>WALL OF FAME</h3>
                 <ul id="highScoreList">
                      <li><span>Loading...</span><span></span></li>
                 </ul>
                 <div class="instructions">
                     Frecce/WASD: Muovi<br>
                     Spazio: Spara<br>
                     P: Pausa
                 </div>
            </div>
        </div>

        <!-- Area Centrale: Canvas e Overlay -->
        <div id="canvasWrapper">
            <canvas id="gameCanvas" width="480" height="640" tabindex="0"></canvas>
            <div id="bossHealthBarContainer">
                <div id="bossHealthBar"></div>
                <div id="bossHealthText">CMDR SCUDERI</div> <!-- Nome Boss Corretto -->
            </div>
            <button id="startButton" class="overlayButton">Inizia Partita</button>
            <div id="gameOverOverlay">
                <h2>FINE PARTITA</h2>
                <p>Punteggio Finale: <span id="finalScore">0</span></p>
                <div id="highScoreEntry">
                    <label for="playerNameInput">Congratulazioni! Nuovo Record!</label>
                    <input type="text" id="playerNameInput" placeholder="Nome Pilota (3-10)" maxlength="10" minlength="3">
                    <button id="saveScoreButton" class="overlayButton">Salva</button>
                </div>
                <button id="restartButton" class="overlayButton">Ricomincia</button>
            </div>
            <div id="pauseOverlay">PAUSA</div>
            <div id="uiMessageDisplay"></div>
        </div>

        <!-- Sidebar Destra: Stato Giocatore -->
        <div id="uiSidebar">
            <h3>STATO</h3>
            <p>Punteggio: <span id="scoreValue">0</span></p>
            <p>Vite: <span id="livesValue">3</span></p>
            <p>Salute: <span id="healthValue">10/10</span></p>
            <div id="healthBarContainer"><div id="healthBar"></div></div>
            <!-- Box Nome Cadetto -->
             <div id="cadetNameContainer">
                 <div>PILOTA</div>
                 <div id="cadetNameDisplay">IN ATTESA...</div>
                 <div>STATO MISSIONE</div>
             </div>
            <p>Arma: <span id="weaponValue">Standard</span></p>
            <p>Stato: <span id="statusValue">OK</span></p>
            <!-- Rimosso riferimenti ai cristalli dalla UI base -->
            <p>Ondata: <span id="waveValue">-</span></p>
            <p>Livello: <span id="levelValue">1</span></p>
            <p>Nemici: <span id="enemiesValue">0</span></p>
        </div>
    </div>

    <!-- === FINE BLOCCO 3 === -->
    <!-- === INSERISCI QUI IL BLOCCO 4 (JavaScript Core & Setup) === -->

    <!-- === INIZIO BLOCCO 4 (JavaScript Core & Setup) === -->
    <script>
        /**
         * CONDORSPACE V2.11.3 - Flusso Integrato
         * BLOCCO 4: Core Setup, Variabili Globali, Audio (Revisionato), Helpers
         */

        // --- Costanti del gioco ---
        const BLINK_INTERVAL = 150; const UI_MESSAGE_DURATION = 1800; const SCREEN_FLASH_DURATION = 150; const ALIEN_PROJECTILE_DAMAGE = 1; const ALIEN_COLLISION_DAMAGE = 3; const POWERUP_DROP_CHANCE = 0.18; const LASER_DPS = 15;
        const DEFAULT_EXPLOSION_COLORS = { primary: "#ff8800", secondary: "#ffaa44", accent: "#ffffff", glow: "#ff6600", energy: "#ffff88" }; const DEFAULT_ALIEN_COLORS = { primary: "#aa00ff", secondary: "#cc66ff", accent: "#ffffff", glow: "#aa00ff", energy: "#ff00ff" };
        window.alienColorSchemes = [ {primary:"#00aaff", secondary:"#80ccff", accent:"#fff", glow:"#00aaff", energy:"#80ffff"}, {primary:"#ff5500", secondary:"#ffaa00", accent:"#fff", glow:"#ff5500", energy:"#ffff00"}, {primary:"#aa00ff", secondary:"#cc66ff", accent:"#fff", glow:"#aa00ff", energy:"#ff00ff"}, {primary:"#00ff66", secondary:"#80ffaa", accent:"#fff", glow:"#00ff66", energy:"#ccff00"}, {primary:"#ff0066", secondary:"#ff80aa", accent:"#fff", glow:"#ff0066", energy:"#ffcc66"}, {primary:"#cc0000", secondary:"#ff6666", accent:"#fff", glow:"#ff0000", energy:"#ffaaaa"} ];
        const HIGH_SCORE_KEY = 'condorspaceHighScores_v4'; const MAX_HIGH_SCORES = 7;
        let prngSeed = Date.now(); function pseudoRandom(){ return prngSeed=(prngSeed*9301+49297)%233280, prngSeed/233280 } function seededPseudoRandom(seed){ let t=seed%2147483647; return t<=0&&(t+=2147483646), ()=>{ return t=(t*16807)%2147483647, (t-1)/2147483646 } }
        const WAVES = [ { name: "Ricognitori Nethex", duration: 35000, spawnInterval: 1600, maxAliensOnScreen: 11, alienTypes: [ { type: 'scout', params: { health: 1, speedY: 80, shootCooldown: 2600, movement: 'straight', speedFactor: 0.95 } }, { type: 'scout_sine', params: { health: 1.2, speedY: 70, shootCooldown: 2800, movement: 'sine', speedFactor: 0.95, sineAmplitude: 55, sineFrequency: 0.016 } } ], pauseAfter: 3500 }, { name: "Squadriglie d'Assalto", duration: 50000, spawnInterval: 1300, maxAliensOnScreen: 15, alienTypes: [ { type: 'fighter', params: { health: 3, speedY: 95, shootCooldown: 1900, movement: 'zigzag', speedFactor: 1.0 } }, { type: 'scout_sine', params: { health: 2, speedY: 80, shootCooldown: 2200, movement: 'sine', speedFactor: 1.0, sineAmplitude: 75, sineFrequency: 0.021 } } ], pauseAfter: 4500 }, { name: "Bombardieri Pesanti", duration: 65000, spawnInterval: 1100, maxAliensOnScreen: 17, alienTypes: [ { type: 'bomber', params: { health: 7, speedY: 65, shootCooldown: 1600, movement: 'straight', speedFactor: 1.1, sizeMultiplier: 1.2 } }, { type: 'fighter_elite', params: { health: 4, speedY: 105, shootCooldown: 1700, movement: 'diagonal', speedFactor: 1.1, isElite: true } } ], pauseAfter: 5500 }, { name: "Guardia Scelta", duration: 50000, spawnInterval: 800, maxAliensOnScreen: 14, alienTypes: [ { type: 'elite_guardian', params: { health: 6, speedY: 125, shootCooldown: 1300, movement: 'sine', speedFactor: 1.2, sineAmplitude: 95, sineFrequency: 0.026, eyeOffset: Math.PI, isElite: true } }, { type: 'kamikaze', params: { health: 1.5, speedY: 200, shootCooldown: 99999, movement: 'straight_fast', speedFactor: 1.5, collisionDamageBoost: 6 } } ], pauseAfter: 7000 } ];
        let canvas, ctx, startButton, gameOverOverlay, restartButton, finalScoreUI, highScoreEntryUI, playerNameInput, saveScoreButton, highScoreListUI, scoreValueUI, livesValueUI, weaponValueUI, levelValueUI, statusValueUI, waveValueUI, enemiesValueUI, pauseOverlay, uiMessageDisplay, healthValueUI, healthBarUI, healthBarContainer, bossHealthBarContainer, bossHealthBar, bossHealthText, introOverlay, skipIntroButton, mainLayout, titleLogoCanvas, titleLogoCtx, cadetRegistrationScreen, cadetRegistrationContainer, cadetNameDisplayUI;
        let animationFrameId = null; let gameBoss = null;
        window.introTimeout = null; window.introAudioPlayed = false; window.introOver = false;
        const game = { animationFrame: 0, lastTime: 0, deltaTime: 0, running: false, paused: false, score: 0, lives: 3, isGameOver: false, level: 1, playerProjectiles: [], aliens: [], alienProjectiles: [], explosions: [], powerUps: [], stars: [], planets: [], crystals: [], globalAlienFireCooldown: 0, alienSeparationBuffer: 7, currentScoreSubmitted: false, uiMessage: "", uiMessageTimer: 0, screenFlashTimer: 0, currentWaveIndex: -1, waveTimer: 0, timeUntilNextWave: 0, inWavePause: true, allWavesCompleted: false, bossSpawned: false, bossDefeated: false, alienSpawnTimer: 0, cadetName: "CADETTO", errorNotified: false };
        const spaceship = { x: 0, y: 0, width: 50, height: 60, speed: 280, thrustPower: 0, engineAnimFrame: 0, engineFrameCount: 0, firing: false, fireDelay: 0, fireRate: 140, moveLeft: false, moveRight: false, moveUp: false, moveDown: false, weaponType: 0, laserBeamActive: false, health: 10, maxHealth: 10, invincibleAfterHit: false, invincibleAfterLifeLoss: false, hitInvincibleTimer: 0, lifeLossInvincibleTimer: 0, HIT_INVINCIBILITY_DURATION: 1100, LIFE_LOSS_INVINCIBILITY_DURATION: 2500, shieldActive: false, shieldTimer: 0, SHIELD_DURATION: 8500, isAlive: true, blinkTimer: 0, takeDamage: function(amount) { if(!this.isAlive||this.shieldActive||this.invincibleAfterHit||this.invincibleAfterLifeLoss)return; this.health-=amount; AudioSystem.playPlayerHitSound(); game.screenFlashTimer=SCREEN_FLASH_DURATION; if(this.health<=0){this.health=0;loseLife();}else{this.invincibleAfterHit=true;this.hitInvincibleTimer=this.HIT_INVINCIBILITY_DURATION;} updateGameUI(game,spaceship);} };
        let currentPlanetTypes = []; const starCount = 160; const starSpeed = 1.0; const MAX_PLANETS = 3; const availablePlanetTypes = [0, 6, 7, 8, 9];

        // --- Sistema Audio (`AudioSystem` con funzioni wrapper corrette) ---
        const AudioSystem = {
             context: null, sfxGainNode: null, musicGainNode: null,
             isInitialized: false, audioUnlockNeeded: true,
             musicElements: {}, continuousLaserSound: null,
             audioFiles: { introMusic:"https://khamurria.github.io/Condorspace/assets/audio/intro_music.mp3", gameplayMusic:"https://khamurria.github.io/Condorspace/assets/audio/gameplay_music.mp3", bossMusic:"https://khamurria.github.io/Condorspace/assets/audio/boss_music.mp3" }, // Rimossa logo music se non usata
             init(callback) { if(this.isInitialized){if(callback)callback();return;} console.log("INFO: Inizializzazione AudioSystem..."); try{window.AudioContext=window.AudioContext||window.webkitAudioContext;if(!window.AudioContext)throw new Error("Web Audio API non supportata.");this.context=new AudioContext();this.sfxGainNode=this.context.createGain();this.sfxGainNode.gain.setValueAtTime(0.6,this.context.currentTime);this.sfxGainNode.connect(this.context.destination);this.musicGainNode=this.context.createGain();this.musicGainNode.gain.setValueAtTime(0.15,this.context.currentTime);this.musicGainNode.connect(this.context.destination);this.audioUnlockNeeded=(this.context.state==='suspended');console.log(`INFO: AudioContext state: ${this.context.state}. Unlock needed: ${this.audioUnlockNeeded}`);this.isInitialized=true;if(callback)callback();}catch(error){console.error("ERRORE: AudioContext init fallita:",error);this.isInitialized=false;if(callback)callback();} },
             resumeContext(callback) { if(!this.context||!this.isInitialized||!this.audioUnlockNeeded){if(callback)callback();return;} if(this.context.state==='suspended'){console.log("INFO: Tentativo resume AudioContext...");this.context.resume().then(()=>{console.log("INFO: AudioContext ripreso.");this.audioUnlockNeeded=false;if(callback)callback();}).catch(error=>{console.error("ERRORE: Resume AudioContext fallito:",error);if(callback)callback();});}else{this.audioUnlockNeeded=false;if(callback)callback();} },
             playMP3Music(id,url,volume=0.5,loop=true){ this.stopAllMP3Music(500); console.log(`INFO: Play MP3 '${id}' from ${url}`); if(this.musicElements[id]){try{this.musicElements[id].pause();}catch(e){}delete this.musicElements[id];} const aE=new Audio(); aE.volume=0;aE.loop=loop;aE.src=url;aE.crossOrigin="anonymous"; this.musicElements[id]=aE; const pP=aE.play(); if(pP!==undefined){pP.then(()=>{const fT=1000,iT=50,st=fT/iT,vS=volume/st;let cV=0;const fI=setInterval(()=>{if(!this.musicElements[id]){clearInterval(fI);return;} cV+=vS; if(cV>=volume){aE.volume=volume;clearInterval(fI);}else{aE.volume=cV;}},iT);}).catch(error=>{console.error(`ERRORE: Play MP3 '${id}' fallito:`,error);delete this.musicElements[id];});} aE.onerror=(e)=>{console.error(`ERRORE: Load MP3 '${id}' fallito:`,e);delete this.musicElements[id];}; },
             stopAllMP3Music(fadeOutTime=0){ console.log(`INFO: Stop MP3 (fade: ${fadeOutTime}ms)`); Object.keys(this.musicElements).forEach(id=>{const aE=this.musicElements[id]; delete this.musicElements[id]; if(!aE)return; if(fadeOutTime>0&&aE.volume>0){const oV=aE.volume,iT=50,st=fadeOutTime/iT,vS=oV/st;const fI=setInterval(()=>{const cV=aE.volume-vS; if(cV<=0){aE.volume=0;aE.pause();aE.currentTime=0;clearInterval(fI);}else{aE.volume=cV;}},iT);}else{aE.pause();aE.currentTime=0;}}); },
             playIntroMP3() { this.playMP3Music('intro', this.audioFiles.introMusic, 0.4, true); },
             playGameplayMP3() { this.playMP3Music('gameplay', this.audioFiles.gameplayMusic, 0.3, true); },
             playBossMP3() { this.playMP3Music('boss', this.audioFiles.bossMusic, 0.4, true); },
             _createToneSweep(type,freqStart,freqEnd,duration,gain=1,attack=0.01,decay=0.1,startTime=null){ if(!this.context||!this.sfxGainNode||this.context.state!=='running')return null;const now=this.context.currentTime;const t=startTime!==null?startTime:now;try{const osc=this.context.createOscillator();osc.type=type;const gN=this.context.createGain();const fS=Math.max(20,freqStart);const fE=Math.max(20,freqEnd);osc.frequency.setValueAtTime(fS,t);if(duration>0.001&&Math.abs(fS-fE)>1)osc.frequency.exponentialRampToValueAtTime(Math.max(0.01,fE),t+duration);gN.gain.setValueAtTime(0,t);if(attack>0.001)gN.gain.linearRampToValueAtTime(gain,t+attack);else gN.gain.setValueAtTime(gain,t);const eT=t+Math.max(attack,duration);gN.gain.setValueAtTime(gN.gain.value,eT);gN.gain.exponentialRampToValueAtTime(0.001,eT+decay);osc.connect(gN).connect(this.sfxGainNode);osc.start(t);osc.stop(eT+decay+0.1);return{o:osc,g:gN};}catch(e){return null;}},
             _createFilteredNoise(duration,freq,Q=1,gain=1,type="bandpass",startTime=null){ if(!this.context||!this.sfxGainNode||this.context.state!=='running')return null;const now=this.context.currentTime;const t=startTime!==null?startTime:now;try{const bS=Math.max(1,Math.floor(this.context.sampleRate*duration));const buf=this.context.createBuffer(1,bS,this.context.sampleRate);const out=buf.getChannelData(0);for(let i=0;i<bS;i++)out[i]=Math.random()*2-1;const nS=this.context.createBufferSource();nS.buffer=buf;nS.loop=false;const f=this.context.createBiquadFilter();f.type=type;f.frequency.setValueAtTime(freq,t);f.Q.setValueAtTime(Q,t);const gN=this.context.createGain();gN.gain.setValueAtTime(0,t);gN.gain.linearRampToValueAtTime(gain,t+0.01);gN.gain.exponentialRampToValueAtTime(0.001,t+duration);nS.connect(f).connect(gN).connect(this.sfxGainNode);nS.start(t);return{n:nS,f:f,ng:gN};}catch(e){return null;}},
             // --- CORREZIONE: play() ora definisce i suoni procedurali ---
             play(soundName) { if (!this.context || this.context.state !== 'running' || !this.sfxGainNode) return null; const t = this.context.currentTime; switch(soundName) { case "buttonClick":this._createToneSweep("sine",700,0,.03,.2,.001,.02,t);this._createToneSweep("square",1200,800,.015,.1,.001,.01,t+.005);this._createFilteredNoise(.02,3000,10,.05,"bandpass",t);break; case "laser":this._createToneSweep("square",780,380,.11,.38,.005,.06,t);break; case "spread":this._createToneSweep("sawtooth",900,450,.1,.32,.005,.05,t);break; case "rapid":this._createToneSweep("triangle",920,500,.07,.28,.003,.04,t);break; case "heavy":this._createToneSweep("sawtooth",280,140,.22,.48,.01,.25,t);this._createToneSweep("square",560,280,.18,.28,.02,.2,t+.02);break; case "alienLaser":const type=Math.random()<.6?"triangle":"sine";const i=900+Math.random()*400;const s=i*(.35+Math.random()*.3);const h=.07+Math.random()*.05;const a=.22+Math.random()*.1;this._createToneSweep(type,i,s,h,a,.005,.05,t);break; case "explosionSmall":this._createFilteredNoise(.3,1600,11,.45,"bandpass",t);this._createToneSweep("square",650,250,.18,.35,.01,.12,t+.02);break; case "explosionMedium":this._createFilteredNoise(.5,900,9,.65,"bandpass",t);this._createToneSweep("sawtooth",450,120,.35,.55,.01,.25,t+.05);this._createToneSweep("square",250,90,.35,.45,.05,.3,t+.1);break; case "explosionLarge":this._createFilteredNoise(1,500,7,.85,"lowpass",t);this._createToneSweep("sawtooth",220,60,.7,.75,.02,.5,t+.05);this._createToneSweep("square",120,50,.8,.65,.1,.6,t+.15);for(let k=0;k<7;k++){this._createFilteredNoise(.06+Math.random()*.04,3500+Math.random()*2500,18+Math.random()*5,.35+Math.random()*.1,"highpass",t+.1+Math.random()*.6);}break; case "megaExplosion":this._createFilteredNoise(1.8,300,5,1,"lowpass",t);this._createToneSweep("sawtooth",180,40,1.2,.9,.03,.8,t+.05);this._createToneSweep("square",100,30,1.4,.8,.15,1,t+.15);for(let k=0;k<15;k++){this._createFilteredNoise(.1+Math.random()*.15,4000+Math.random()*3000,15+Math.random()*10,.4+Math.random()*.3,"highpass",t+.2+Math.random()*1.5);}this._createToneSweep("sine",80,50,3,.3,1,2,t+.5);break; case "powerup":this._createToneSweep("sine",800,1500,.35,.55,.01,.2,t);this._createToneSweep("sine",1200,1900,.25,.45,.01,.1,t+.1);break; case "shieldUp":this._createToneSweep("sine",440,880,.4,.6,.01,.25,t);this._createToneSweep("triangle",660,1320,.3,.5,.02,.15,t+.1);break; case "shieldDown":this._createToneSweep("sawtooth",660,220,.4,.3,.01,.3,t);break; case "playerHit":this._createToneSweep("sawtooth",500,100,.3,.65,.005,.2,t);this._createFilteredNoise(.3,1200,6,.5,"lowpass",t);break; case "gameOver":this._createToneSweep("sawtooth",400,100,1.2,.5,.05,.6,t);this._createToneSweep("sawtooth",300,80,1.1,.4,.1,.7,t+.2);break; case "gameStart":this._createToneSweep("sawtooth",220,770,.6,.5,.02,.3,t);this._createToneSweep("square",440,990,.5,.4,.01,.2,t+.1);break; case 'crystalSmall':this._createToneSweep("sine",440,880,.1,.3,.01,.05,t);this._createToneSweep("triangle",660,770,.05,.2,.01,.03,t+.02);break; case 'crystalMedium':this._createToneSweep("sine",440,880,.15,.4,.01,.08,t);this._createToneSweep("triangle",660,1100,.1,.3,.01,.05,t+.05);this._createFilteredNoise(.05,4000,15,.1,"highpass",t+.02);break; case 'crystalLarge':this._createToneSweep("sine",440,880,.15,.5,.01,.1,t);this._createToneSweep("triangle",660,1100,.12,.4,.01,.08,t+.05);this._createToneSweep("sine",880,1320,.1,.3,.01,.05,t+.1);this._createFilteredNoise(.1,3500,12,.15,"highpass",t+.05);break; case 'crystalRare':this._createToneSweep("sine",440,880,.15,.6,.01,.12,t);this._createToneSweep("triangle",660,1320,.12,.5,.01,.1,t+.08);this._createToneSweep("sine",880,1760,.1,.4,.01,.08,t+.16);this._createToneSweep("triangle",1320,2200,.08,.3,.01,.05,t+.24);this._createFilteredNoise(.2,3000,10,.2,"highpass",t+.2);break; default:console.warn(`WARN: Suono non definito: ${soundName}`);break; }
            },
            // --- CORREZIONE: Funzioni wrapper pubbliche ---
            playButtonSound(){this.play('buttonClick');}, playLaserSound(){this.play('laser');}, playSpreadSound(){this.play('spread');}, playRapidSound(){this.play('rapid');}, playHeavySound(){this.play('heavy');}, playAlienLaserSound(){this.play('alienLaser');}, playExplosionSound(size='small'){if(size==='large')this.play('explosionLarge');else if(size==='medium')this.play('explosionMedium');else this.play('explosionSmall');}, playMegaExplosionSound(){this.play('megaExplosion');}, playPowerUpSound(){this.play('powerup');}, playPlayerHitSound(){this.play('playerHit');}, playGameOverSound(){this.play('gameOver');}, playGameStartSound(){this.play('gameStart');}, playShieldUpSound(){this.play('shieldUp');}, playShieldDownSound(){this.play('shieldDown');}, playCrystalSound(rarity=0){if(rarity>=3)this.play('crystalRare');else if(rarity===2)this.play('crystalLarge');else if(rarity===1)this.play('crystalMedium');else this.play('crystalSmall');},
            startContinuous() { /* ... Implementazione startContinuous precedente ... */ if(!this.context||this.context.state!=='running')return;this.stopContinuous();const n=this.context.currentTime;const o1=this.context.createOscillator();o1.type="sawtooth";const o2=this.context.createOscillator();o2.type="sine";const gn=this.context.createGain();const f=this.context.createBiquadFilter();f.type="bandpass";const l=this.context.createOscillator();l.type="sine";const lg=this.context.createGain();o1.frequency.setValueAtTime(880,n);o1.frequency.linearRampToValueAtTime(920,n+0.1);o2.frequency.setValueAtTime(440,n);gn.gain.setValueAtTime(0,n);gn.gain.linearRampToValueAtTime(0.3,n+0.05);f.frequency.setValueAtTime(2000,n);f.Q.setValueAtTime(5,n);l.frequency.setValueAtTime(8,n);lg.gain.setValueAtTime(400,n);o1.connect(f);o2.connect(f);f.connect(gn).connect(this.sfxGainNode);l.connect(lg).connect(f.frequency);o1.start(n);o2.start(n);l.start(n);this.continuousLaserSound={osc1:o1,osc2:o2,lfo:l,gain:gn,filter:f,lfoGain:lg}; },
            stopContinuous() { /* ... Implementazione stopContinuous precedente ... */ if(!this.continuousLaserSound||!this.context)return;const n=this.context.currentTime;const s=this.continuousLaserSound;try{s.gain.gain.setValueAtTime(s.gain.gain.value,n);s.gain.gain.linearRampToValueAtTime(0,n+0.1);}catch(e){}try{s.osc1.stop(n+0.15);}catch(e){}try{s.osc2.stop(n+0.15);}catch(e){}try{s.lfo.stop(n+0.15);}catch(e){}this.continuousLaserSound=null;}
        };

        // --- Funzioni Helper ---
        function getRandomColor(){return window.alienColorSchemes[Math.floor(Math.random()*window.alienColorSchemes.length)];}
        function isColliding(rA,rB){return rA.x<rB.x+rB.width&&rA.x+rA.width>rB.x&&rA.y<rB.y+rB.height&&rA.y+rA.height>rB.y;}
        function isSpaceshipCurrentlyVisible(){if(!spaceship.isAlive)return false;if(spaceship.shieldActive)return true;if(!spaceship.invincibleAfterHit&&!spaceship.invincibleAfterLifeLoss)return true;const rem=Math.max(spaceship.hitInvincibleTimer,spaceship.lifeLossInvincibleTimer);return(rem%(BLINK_INTERVAL*2))<BLINK_INTERVAL;}
        function hexToRgba(hex,alpha=1){hex=hex.replace('#','');if(hex.length===3)hex=hex.split('').map(c=>c+c).join('');const bI=parseInt(hex,16);if(isNaN(bI))return`rgba(255,255,255,${alpha})`;const r=(bI>>16)&255,g=(bI>>8)&255,b=bI&255;const cA=Math.max(0,Math.min(1,alpha));return`rgba(${r},${g},${b},${cA})`;}

    </script>
    <!-- === FINE BLOCCO 4 === -->
    <!-- === INSERISCI QUI IL BLOCCO 5 (JavaScript Game Object Classes) === -->

    <!-- === INIZIO BLOCCO 5 (JavaScript Game Object Classes) === -->
    <script>
        // --- Classe Projectile (Proiettili giocatore) ---
        class Projectile {
             constructor(x, y, type = 0, angle = 0) { this.x=x;this.y=y;this.type=type;this.angle=angle;this.active=true; switch(this.type){ case 0:this.width=6;this.height=16;this.speed=600;this.damage=1;break; case 1:this.width=5;this.height=12;this.speed=540;this.damage=1;break; case 2:this.width=4;this.height=12;this.speed=720;this.damage=0.75;break; case 3:this.width=10;this.height=20;this.speed=420;this.damage=2.5;break; default:this.width=6;this.height=16;this.speed=600;this.damage=1;break; } }
             update(deltaTime) { if(!this.active)return; const dtS=deltaTime/1000; const mD=this.speed*dtS; if(this.type===1){this.x+=Math.sin(this.angle)*mD; this.y-=Math.cos(this.angle)*mD;} else {this.y-=mD;} if(this.y<-this.height||this.x<-this.width||this.x>canvas.width){this.active=false;} }
             draw(animFrame){ if(!this.active||!ctx)return; ctx.save(); let grad,fO=0; const cA=animFrame%4; let c1="#fff",c2="#0ff",sC="#0ff"; switch(this.type){case 1:c2="#0f6";sC="#0f6";break; case 2:c2="#fc0";sC="#fc0";break; case 3:c2="#f06";sC="#f06";break;} grad=ctx.createLinearGradient(this.x,this.y,this.x,this.y+this.height); grad.addColorStop(0,c1); grad.addColorStop(1,c2); ctx.fillStyle=grad; ctx.shadowColor=sC; ctx.shadowBlur=8+this.type; ctx.fillRect(this.x,this.y,this.width,this.height); fO=1+cA; try{ctx.fillStyle=hexToRgba(sC,0.3);}catch{ctx.fillStyle=sC+"4D";} ctx.shadowBlur=0; ctx.fillRect(this.x-fO,this.y-fO,this.width+fO*2,this.height+fO*2); ctx.restore(); }
        }

        // --- Classe AlienProjectile (Proiettili nemici) ---
        class AlienProjectile {
             constructor(x, y, speed = 180, size = 5, color = "#f44", tracking = 0) { this.x=x;this.y=y;this.initialSpeed=speed+Math.random()*Math.max(1,speed*0.3);this.speedX=0;this.speedY=this.initialSpeed;this.width=size;this.height=size*1.5;this.color=color;this.active=true;this.damage=ALIEN_PROJECTILE_DAMAGE;this.trackingFactor=tracking*0.002*Math.min(game.level,5);this.turnSpeed=(100+Math.random()*50)*(1+tracking);this.lifeTimer=null;}
             update(deltaTime) { if(!this.active)return; const dtS=deltaTime/1000; if(this.trackingFactor>0&&spaceship.isAlive){ const tX=spaceship.x+spaceship.width/2; const tY=spaceship.y+spaceship.height/2; const dx=tX-this.x; const dy=tY-this.y; const angT=Math.atan2(dy,dx); let curA=Math.atan2(this.speedX,-this.speedY); let angD=angT-(curA+Math.PI/2); while(angD<=-Math.PI)angD+=2*Math.PI; while(angD>Math.PI)angD-=2*Math.PI; const turn=Math.min(Math.abs(angD),this.turnSpeed*this.trackingFactor*dtS)*Math.sign(angD); curA+=turn; const totS=Math.sqrt(this.speedX*this.speedX+this.speedY*this.speedY); this.speedX=Math.sin(curA)*totS; this.speedY=-Math.cos(curA)*totS; } this.x+=this.speedX*dtS; this.y+=this.speedY*dtS; if(this.lifeTimer!==null){ this.lifeTimer-=deltaTime; if(this.lifeTimer<=0){if(typeof this.explode==='function')this.explode();else this.active=false; return;} if(spaceship.isAlive&&!spaceship.shieldActive&&isColliding(this,spaceship)){if(typeof this.explode==='function')this.explode();else this.active=false; spaceship.takeDamage(ALIEN_COLLISION_DAMAGE+3);} } if(this.y>canvas.height+this.height||this.y<-this.height||this.x<-this.width||this.x>canvas.width+this.width){this.active=false;} }
             draw() { if(!this.active||!ctx)return; ctx.save(); ctx.fillStyle=this.color; ctx.shadowColor=this.color; ctx.shadowBlur=5+this.width*0.5; ctx.beginPath(); ctx.ellipse(this.x+this.width/2,this.y+this.height/2,this.width/2,this.height/2,0,0,2*Math.PI); ctx.fill(); try{ctx.fillStyle=hexToRgba(this.color,0.6);}catch{ctx.fillStyle=this.color+"99";} ctx.shadowBlur=0; ctx.beginPath(); ctx.ellipse(this.x+this.width/2,this.y+this.height*0.2,this.width/3,this.height/4,0,0,2*Math.PI); ctx.fill(); ctx.restore(); }
        }

        // --- Classe Alien (Nemici) ---
        class Alien {
             constructor(x, y, size, colors, movementType, params) { this.id=`${Date.now()}-${Math.random()}`; this.x=x; this.y=y; this.size=size*(params.sizeMultiplier||1); this.colors=colors||getRandomColor(); this.rotation=Math.random()*Math.PI*2; this.rotationSpeed=(Math.random()-0.5)*0.03*(params.speedFactor||1); this.pulsePhase=Math.random()*Math.PI*2; this.energyPulse=1; this.shieldOpacity=0.4; this.tentaclePhase=Math.random()*Math.PI*2; this.collisionRadius=this.size*0.8; this.width=this.collisionRadius*2; this.height=this.collisionRadius*2; this.maxHealth=params.health; this.health=this.maxHealth; this.damaged=false; this.damageFrame=0; this.hitEffects=[]; this.active=true; this.speedY=params.speedY*(params.speedFactor||1); this.movementType=movementType; this.startX=x; this.sineAmplitude=(params.sineAmplitude!==undefined?params.sineAmplitude:(15+Math.random()*35))*(this.size/30)*(params.sineAmplitudeFactor||1); this.sineFrequency=(params.sineFrequency!==undefined?params.sineFrequency:(0.012+Math.random()*0.02))*(params.speedFactor||1)*(params.sineFrequencyFactor||1); this.zigZagSpeedX=(params.speedFactor||1)*(70+Math.random()*110); this.zigZagDir=Math.random()<0.5?1:-1; this.diagonalDir=this.zigZagDir; this.shootTimer=(params.shootCooldown||3000)/2+Math.random()*(params.shootCooldown||3000); this.shootCooldown=params.shootCooldown||3000; this.collisionDamage=params.collisionDamageBoost?ALIEN_COLLISION_DAMAGE+params.collisionDamageBoost:ALIEN_COLLISION_DAMAGE; this.eyeOffset=params.eyeOffset||0; this.targetPlayer=(this.movementType==='straight_fast'); this.isElite=params.isElite||false; this.dropExtraChance=this.isElite?0.6:0.3; }
             update(deltaTime) { if(!this.active)return false; const dtS=deltaTime/1000; const dtR=deltaTime/(1000/60); let pX=this.x; let pY=this.y+this.speedY*dtS; let applyH=true; if(this.targetPlayer&&spaceship.isAlive){ const tX=spaceship.x+spaceship.width/2; const dx=tX-this.x; pX+=Math.sign(dx)*Math.min(Math.abs(dx*0.5),this.speedY*0.8)*dtS; applyH=false; } else{ switch(this.movementType){ case'sine':pX=this.startX+Math.sin(game.lastTime*this.sineFrequency+this.pulsePhase)*this.sineAmplitude;break; case'zigzag':pX+=this.zigZagSpeedX*this.zigZagDir*dtS;break; case'diagonal':pX+=this.zigZagSpeedX*this.diagonalDir*0.7*dtS;break; default:applyH=false;break; } } if(applyH){ for(const o of game.aliens){ if(o===this||!o.active)continue; const dx=pX-o.x; const dy=pY-o.y; const dSq=dx*dx+dy*dy; const mD=this.collisionRadius+o.collisionRadius+game.alienSeparationBuffer; if(dSq<mD*mD&&Math.abs(dx)<mD*0.8){pX=this.x; break;}} } this.y=pY; this.x=pX; if(this.movementType==='zigzag'||this.movementType==='diagonal'){ if((this.x>canvas.width-this.collisionRadius&&this.zigZagDir>0)||(this.x<this.collisionRadius&&this.zigZagDir<0)){this.zigZagDir*=-1; if(this.movementType==='diagonal')this.diagonalDir*=-1;} } this.x=Math.max(this.collisionRadius,Math.min(canvas.width-this.collisionRadius,this.x)); this.rotation+=this.rotationSpeed*dtR; this.energyPulse=0.9+Math.sin(game.animationFrame*0.06+this.pulsePhase)*0.1; this.shieldOpacity=0.3+Math.sin(game.animationFrame*0.04+this.pulsePhase+1)*0.1; this.tentaclePhase+=0.015*dtR; if(this.damaged){this.damageFrame--; if(this.damageFrame<=0)this.damaged=false;} this.hitEffects=this.hitEffects.filter(e=>{e.life-=0.1*dtR; e.size*=(1-0.05*dtR); return e.life>0;}); if(!this.targetPlayer){ this.shootTimer-=deltaTime; const wave=(game.currentWaveIndex>=0&&game.currentWaveIndex<WAVES.length)?WAVES[game.currentWaveIndex]:null; const maxS=wave?Math.max(2,Math.floor(wave.maxAliensOnScreen*0.4)):3; const actS=game.aliens.filter(a=>a.active&&a.shootTimer<500&&!a.targetPlayer).length; if(this.shootTimer<=0&&this.y>-this.size&&this.y<canvas.height-50){ if(game.globalAlienFireCooldown<=0&&actS<maxS+Math.floor(game.level/2)){this.shoot(); this.shootTimer=this.shootCooldown+(Math.random()-0.5)*(this.shootCooldown*0.3); game.globalAlienFireCooldown=50+Math.random()*50;} else {this.shootTimer=80+Math.random()*120;} } } if(game.globalAlienFireCooldown>0)game.globalAlienFireCooldown-=deltaTime; if(this.y>canvas.height+this.size*2){this.active=false; return false;} if(spaceship.isAlive&&!spaceship.shieldActive&&!spaceship.invincibleAfterHit&&!spaceship.invincibleAfterLifeLoss&&isColliding(this,spaceship)){ spaceship.takeDamage(this.collisionDamage); if(this.targetPlayer)this.health=0; this.takeDamage(5); if(!this.active)return false; } return true; }
             shoot() { const x=this.x; const y=this.y+this.collisionRadius*0.5; const bS=160+game.level*5; const s=bS+(Math.random()-0.5)*80; const pS=Math.max(3,Math.min(8,this.size*(0.15+Math.random()*0.1))); const c=this.colors?.energy||"#f60"; const fC=Math.random()<0.2?(this.colors?.secondary||c):c; const tr=(this.movementType==='elite_guardian'||this.movementType==='fighter_elite'||this.isElite)?(0.1+Math.random()*0.15):0; game.alienProjectiles.push(new AlienProjectile(x,y,s,pS,fC,tr)); AudioSystem.playAlienLaserSound(); }
             takeDamage(amount) { if(!this.active)return false; this.health-=amount; this.damaged=true; this.damageFrame=6; this.hitEffects.push({x:(Math.random()-0.5)*this.collisionRadius*0.6,y:(Math.random()-0.5)*this.collisionRadius*0.6,size:this.collisionRadius*0.5*(1+Math.random()*0.5),life:1}); if(this.health<=0){ this.active=false; let sB=Math.floor(this.size*2.0+this.maxHealth*5); if(this.targetPlayer)sB=Math.floor(sB*0.5); if(this.isElite)sB=Math.floor(sB*1.5); game.score+=sB; let eS="small"; if(this.size>45)eS="large"; else if(this.size>30)eS="medium"; const eC=(this.colors&&typeof this.colors==='object')?this.colors:DEFAULT_ALIEN_COLORS; game.explosions.push(new Explosion(this.x,this.y,this.size*1.2,eC,eS)); AudioSystem.playExplosionSound(eS); if(!this.targetPlayer){ if(Math.random()<POWERUP_DROP_CHANCE)spawnPowerUp(this.x,this.y); if(typeof spawnCrystalsFromAlien==='function')spawnCrystalsFromAlien(this);} return true; } return false; }
             drawTentacles() { const numT=5+Math.floor(this.size/15); const lenT=this.size*1.8*this.energyPulse; ctx.lineWidth=Math.max(1,this.size*0.1); ctx.lineCap="round"; const enC=this.colors?.energy||"#80ffff"; for(let i=0;i<numT;i++){ const ang=(i/numT)*Math.PI*2+this.rotation+this.pulsePhase*0.5; const len=lenT*(0.6+Math.sin(game.animationFrame*0.07+this.tentaclePhase+i*0.9)*0.4); const grad=ctx.createLinearGradient(0,0,Math.cos(ang)*len,Math.sin(ang)*len); try{grad.addColorStop(0,hexToRgba(enC,0.67));grad.addColorStop(0.7,hexToRgba(enC,0.27));grad.addColorStop(1,hexToRgba(enC,0));}catch{grad.addColorStop(0,enC+"AA");grad.addColorStop(1,enC+"00");} ctx.strokeStyle=grad; ctx.beginPath();ctx.moveTo(0,0); const seg=6; let pX=0, pY=0; for(let j=1;j<=seg;j++){ const t=j/seg; const segL=len*t; const swayM=this.size*0.18*t*t; const swayA=Math.sin(t*2.5+game.animationFrame*0.1+this.tentaclePhase+i)*(swayM/Math.max(1,segL)); const curA=ang+swayA; const x=Math.cos(curA)*segL; const y=Math.sin(curA)*segL; ctx.quadraticCurveTo(pX+(x-pX)*0.5,pY+(y-pY)*0.5,x,y); pX=x; pY=y; } ctx.stroke();} }
             draw() { if(!this.active||!ctx)return; ctx.save();ctx.translate(this.x,this.y); this.drawTentacles(); if(this.damaged&&game.animationFrame%2===0){ctx.fillStyle="rgba(255,100,100,0.5)";ctx.beginPath();ctx.arc(0,0,this.size*1.1,0,2*Math.PI);ctx.fill();} if(this.health<this.maxHealth&&!this.targetPlayer){const bW=this.collisionRadius*1.5;const bH=Math.max(4,this.collisionRadius*0.1);const bY=-this.collisionRadius-bH*2.5;const cW=bW*(this.health/this.maxHealth);ctx.fillStyle="rgba(50,50,50,0.6)";ctx.fillRect(-bW/2,bY,bW,bH);ctx.fillStyle=this.health/this.maxHealth>0.5?"#4f4":this.health/this.maxHealth>0.2?"#ff4":"#f44";ctx.fillRect(-bW/2,bY,cW,bH);} const gR=this.size*(1.3+Math.sin(game.animationFrame*0.05+this.pulsePhase)*0.15);const gG=ctx.createRadialGradient(0,0,this.size*0.1,0,0,gR);const gC=this.colors?.glow||"#0af";try{gG.addColorStop(0,hexToRgba(gC,0.18));gG.addColorStop(0.5,hexToRgba(gC,0.08));gG.addColorStop(1,hexToRgba(gC,0));}catch{gG.addColorStop(0,gC+"30");gG.addColorStop(1,gC+"00");} ctx.fillStyle=gG;ctx.beginPath();ctx.arc(0,0,gR,0,2*Math.PI);ctx.fill(); const sG=ctx.createRadialGradient(0,0,this.size*0.2,0,0,this.size);const sC=this.colors?.secondary||"#8cf";try{sG.addColorStop(0,"rgba(255,255,255,0)");sG.addColorStop(0.7,hexToRgba(sC,0.1));sG.addColorStop(0.9,hexToRgba(sC,0.2));sG.addColorStop(1,hexToRgba(sC,0.3));}catch{sG.addColorStop(0.7,sC+"1A");sG.addColorStop(1,sC+"4D");} ctx.fillStyle=sG;ctx.globalAlpha=this.shieldOpacity;ctx.beginPath();ctx.arc(0,0,this.size,0,2*Math.PI);ctx.fill();ctx.globalAlpha=1; ctx.rotate(this.rotation);const pts=6;const oR=this.size*0.7;const iR=oR*0.85;ctx.lineWidth=Math.max(1,this.size*0.08);ctx.strokeStyle=this.colors?.primary||"#0af";ctx.beginPath();for(let i=0;i<pts;i++){const a=(i/pts)*Math.PI*2;const x=Math.cos(a)*oR;const y=Math.sin(a)*oR;if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);}ctx.closePath();ctx.stroke(); ctx.lineWidth=Math.max(0.5,this.size*0.03);ctx.strokeStyle=this.colors?.secondary||"#8cf";for(let i=0;i<pts;i++){const a=(i/pts)*Math.PI*2+Math.PI/pts;const x=Math.cos(a)*iR;const y=Math.sin(a)*iR;ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(x,y);ctx.stroke();} const coreR=this.size*0.3*this.energyPulse;if(coreR>0.5){const coreG=ctx.createRadialGradient(0,0,coreR*0.1,0,0,coreR);const enC=this.colors?.energy||"#8ff";const prC=this.colors?.primary||"#0af";coreG.addColorStop(0,"#fff");coreG.addColorStop(0.3,enC);coreG.addColorStop(1,prC);ctx.fillStyle=coreG;ctx.beginPath();ctx.arc(0,0,coreR,0,2*Math.PI);ctx.fill();ctx.lineWidth=Math.max(0.5,this.size*0.02);ctx.strokeStyle=this.colors?.accent||"#fff";ctx.beginPath();ctx.arc(0,0,coreR*1.3,0,2*Math.PI);ctx.stroke();} const eO=this.eyeOffset||0;const nE=this.targetPlayer?1:3;const eBA=this.targetPlayer?Math.PI:Math.PI/6;const eD=coreR*(this.targetPlayer?2.0:1.8);const eyes=[];if(nE===1)eyes.push({a:eBA+eO,d:eD});else{eyes.push({a:-eBA+eO,d:eD});eyes.push({a:eBA+eO,d:eD});eyes.push({a:Math.PI+eO,d:eD});} const eC=this.colors?.energy||"#8ff";ctx.shadowColor=eC;ctx.shadowBlur=this.size*0.1;ctx.fillStyle=eC;if(coreR>0.1){eyes.forEach(eye=>{const x=Math.cos(eye.a)*eye.d;const y=Math.sin(eye.a)*eye.d;const eS=Math.max(1,this.size*0.07*(0.8+Math.sin(game.animationFrame*0.1+this.pulsePhase+eye.a)*0.2));ctx.beginPath();ctx.arc(x,y,eS,0,2*Math.PI);ctx.fill();});}ctx.shadowBlur=0; for(const hit of this.hitEffects){ctx.globalAlpha=hit.life;const hG=ctx.createRadialGradient(hit.x,hit.y,0,hit.x,hit.y,hit.size);hG.addColorStop(0,"rgba(255,255,200,0.9)");hG.addColorStop(0.5,"rgba(255,200,0,0.7)");hG.addColorStop(1,"rgba(255,255,255,0)");ctx.fillStyle=hG;ctx.beginPath();ctx.arc(hit.x,hit.y,Math.max(1,hit.size),0,2*Math.PI);ctx.fill();ctx.globalAlpha=1.0;} if(this.isElite){ctx.lineWidth=Math.max(0.5,this.size*0.03);ctx.strokeStyle="rgba(255,255,0,0.6)";const auraP=Math.sin(game.animationFrame*0.08)*2;ctx.beginPath();ctx.arc(0,0,this.size*1.1+auraP,0,Math.PI*2);ctx.stroke();} ctx.restore(); }
        }

        // --- Classe Explosion ---
        class Explosion {
             constructor(x, y, baseSize, colors, sizeCategory = 'small') { this.x=x;this.y=y;this.baseSize=baseSize;this.colors={primary:colors?.primary||DEFAULT_EXPLOSION_COLORS.primary,secondary:colors?.secondary||DEFAULT_EXPLOSION_COLORS.secondary,accent:colors?.accent||DEFAULT_EXPLOSION_COLORS.accent,glow:colors?.glow||DEFAULT_EXPLOSION_COLORS.glow,energy:colors?.energy||DEFAULT_EXPLOSION_COLORS.energy};this.particles=[];this.life=1.0;this.active=true;this.sizeCategory=sizeCategory;this.type=colors?.type||'explosion'; if(this.type==='explosion'&&sizeCategory!=='custom'){this.createParticles();}else if(this.type==='beam'){this.life=colors.life||1000;this.startTime=colors.startTime||Date.now();this.drawBeam=colors.draw;this.dps=colors.dps||0;this.bossRef=colors.bossRef;} }
             createParticles() { let m=1,pS=this.baseSize/12,bS=3.5,sS=1.6,sC=0.3;if(this.sizeCategory==="medium"){m=2;pS=this.baseSize/10;bS=4.5;sS=2;sC=0.5;}else if(this.sizeCategory==="large"){m=3.5;pS=this.baseSize/8;bS=5.5;sS=2.5;sC=0.7;}const nP=Math.floor(20*m+Math.random()*12*m);const pC=this.colors.primary;const eC=this.colors.energy;for(let i=0;i<nP;i++){const iF=Math.random()<0.4;this.particles.push({type:iF?"fragment":"square",x:(Math.random()-0.5)*this.baseSize*0.1,y:(Math.random()-0.5)*this.baseSize*0.1,size:Math.random()*pS+pS*0.6,speed:(Math.random()*bS+bS*0.6)*(iF?1.1:0.9),angle:Math.random()*Math.PI*2,rotation:Math.random()*Math.PI*2,rotationSpeed:(Math.random()-0.5)*0.15,color:Math.random()>0.4?pC:eC,life:1+Math.random()*0.6,decay:0.01+Math.random()*0.015});} if(this.sizeCategory==='medium'||this.sizeCategory==='large'){const nS=(this.sizeCategory==='large'?3:2);for(let i=0;i<nS;i++){this.particles.push({type:"shockwave",size:0,maxSize:this.baseSize*(sS+i*0.4),speed:(bS*0.9+i*1.8)*(0.9+Math.random()*0.3),opacity:0.8-i*0.18,color:i%2===0?this.colors.energy:this.colors.primary,life:1,decay:0.016+i*0.003});}} this.particles.push({type:"flash",size:this.baseSize*1.5,life:0.4,decay:0.05}); }
             update(deltaTime) { if(!this.active)return false;if(this.type==='beam'){/* vita gestita in drawBeam */ return this.active;}const dtR=deltaTime/(1000/60);this.life-=0.015*dtR;let hasActP=false;for(let i=this.particles.length-1;i>=0;i--){const p=this.particles[i];p.life-=p.decay*dtR;if(p.life<=0){this.particles.splice(i,1);continue;}hasActP=true;switch(p.type){case"shockwave":p.size+=p.speed*Math.max(0.1,p.life)*dtR;p.opacity=Math.max(0,p.opacity-p.decay*1.2*dtR);p.speed*=(1-0.015*dtR);break;case"flash":p.size*=(1+p.decay*0.5*dtR);break;default:p.x+=Math.cos(p.angle)*p.speed*Math.max(0.1,p.life)*dtR;p.y+=Math.sin(p.angle)*p.speed*Math.max(0.1,p.life)*dtR;p.rotation+=p.rotationSpeed*dtR;p.speed*=(1-(0.03+p.decay)*dtR);p.size=Math.max(0,p.size-p.decay*20*dtR);break;}}if(this.life<=0&&!hasActP)this.active=false;return this.active;}
             draw(ctx) { if(!this.active||!ctx)return;if(this.type==='beam'&&this.drawBeam){this.drawBeam(ctx);return;}ctx.save();ctx.translate(this.x,this.y);const sA=this.colors.accent||"#fff";const sE=this.colors.energy||"#ff0";const sP=this.colors.primary||"#f80";ctx.globalCompositeOperation="source-over";this.particles.forEach(p=>{if(p.life>0&&p.size>=0.5&&p.type!=="shockwave"&&p.type!=="flash"){ctx.save();ctx.translate(p.x,p.y);ctx.rotate(p.rotation);ctx.globalAlpha=Math.max(0,p.life*1.2);ctx.fillStyle=p.color;if(p.type==="fragment"){ctx.beginPath();const sz=p.size/2;ctx.moveTo(0,-sz*1.2);ctx.lineTo(sz,sz*0.8);ctx.lineTo(-sz,sz*0.8);ctx.closePath();ctx.fill();}else{ctx.fillRect(-p.size/2,-p.size/2,p.size,p.size);}ctx.restore();}});ctx.globalCompositeOperation="lighter";this.particles.forEach(p=>{if(p.life>0&&p.type==="flash"){try{const cS=p.size*p.life;const g=ctx.createRadialGradient(0,0,0,0,0,cS);g.addColorStop(0,sA+"FF");g.addColorStop(0.2,sE+"CC");g.addColorStop(0.6,sP+"99");g.addColorStop(1,sP+"00");ctx.fillStyle=g;ctx.globalAlpha=Math.max(0,p.life*2.5);ctx.beginPath();ctx.arc(0,0,cS,0,2*Math.PI);ctx.fill();}catch(e){}}});this.particles.forEach(p=>{if(p.life>0&&p.size>=1&&p.type==="shockwave"){ctx.globalAlpha=p.opacity*p.life;ctx.strokeStyle=p.color;ctx.lineWidth=Math.max(1,this.baseSize/20*p.life*(1.5+(p.maxSize/this.baseSize)*0.1));ctx.beginPath();ctx.arc(0,0,p.size,0,2*Math.PI);ctx.stroke();}});ctx.restore();}
        }

        // --- Classe PowerUp ---
        class PowerUp {
             constructor(x, y, type) { this.x=x;this.y=y;this.width=28;this.height=28;this.type=type;this.speed=110+Math.random()*40;this.active=true;this.rotationAngle=Math.random()*Math.PI*2;this.pulseSize=0;this.pulseSpeed=0.08+Math.random()*0.04;this.rotationSpeed=(Math.random()-0.5)*0.05;}
             update(deltaTime) { if(!this.active)return;const dtS=deltaTime/1000;const dtR=deltaTime/(1000/60);this.y+=this.speed*dtS;this.rotationAngle+=this.rotationSpeed*dtR;this.pulseSize=Math.sin(game.animationFrame*this.pulseSpeed)*2.5;if(this.y>canvas.height+this.height){this.active=false;return;}if(spaceship.isAlive&&isColliding(this,{x:spaceship.x+spaceship.width*0.1,y:spaceship.y+spaceship.height*0.1,width:spaceship.width*0.8,height:spaceship.height*0.8})){this.applyEffect();this.active=false;updateGameUI(game,spaceship);}}
             applyEffect() { let wT="",mC="#ffff88",sM=true,snd='powerup';switch(this.type){case 5:spaceship.shieldActive=true;spaceship.shieldTimer=spaceship.SHIELD_DURATION;snd='shieldUp';game.uiMessage="Scudo Attivato!";mC="#80ffff";break;case 6:const hB=spaceship.health;spaceship.health=Math.min(spaceship.maxHealth,spaceship.health+4);snd='powerup';game.uiMessage=hB<spaceship.maxHealth?"Riparazione!":"Salute Max!";mC="#8f8";break;default:if(spaceship.weaponType===this.type){game.score+=250;sM=false;}else{spaceship.weaponType=this.type;if(spaceship.laserBeamActive&&this.type!==4){if(AudioSystem)AudioSystem.stopContinuous();spaceship.laserBeamActive=false;}} switch(this.type){case 1:wT="Spread";mC="#6fa";snd='spread';break;case 2:wT="Rapid";mC="#fe8";snd='rapid';break;case 3:wT="Heavy";mC="#f9b";snd='heavy';break;case 4:wT="Laser";mC="#e8f";snd='laser';break;}if(sM){game.uiMessage=`Arma: ${wT}!`;}break;}if(sM&&uiMessageDisplay){game.uiMessageTimer=UI_MESSAGE_DURATION;uiMessageDisplay.style.color=mC;uiMessageDisplay.textContent=game.uiMessage;uiMessageDisplay.classList.add('visible');}if(AudioSystem)AudioSystem.play(snd);}
             draw() { if(!this.active||!ctx)return;ctx.save();ctx.translate(this.x+this.width/2,this.y+this.height/2);ctx.rotate(this.rotationAngle);let pC="#fff",sC="#aaa",gC="#fff",tC="?";const cS=this.width/2+this.pulseSize/2;switch(this.type){case 1:pC="#6fa";sC="#082";gC="#0f6";tC="S";break;case 2:pC="#fe8";sC="#c90";gC="#fc0";tC="R";break;case 3:pC="#f9b";sC="#c04";gC="#f06";tC="H";break;case 4:pC="#e8f";sC="#80c";gC="#c1f";tC="L";break;case 5:pC="#8df";sC="#069";gC="#0af";tC="";break;case 6:pC="#8f8";sC="#060";gC="#4f4";tC="+";break;}ctx.shadowColor=gC;ctx.shadowBlur=15+this.pulseSize*1.5;const bgG=ctx.createRadialGradient(0,0,3,0,0,cS);try{bgG.addColorStop(0,"#fff");bgG.addColorStop(0.4,pC);bgG.addColorStop(1,sC);}catch{bgG.addColorStop(0,pC);bgG.addColorStop(1,sC);}ctx.fillStyle=bgG;ctx.beginPath();ctx.arc(0,0,cS,0,2*Math.PI);ctx.fill();ctx.strokeStyle=pC+"aa";ctx.lineWidth=1.5;ctx.beginPath();ctx.arc(0,0,cS+1,0,2*Math.PI);ctx.stroke();ctx.shadowBlur=0;if(this.type===5){const sS=cS*0.8+Math.sin(game.animationFrame*0.15)*1.5;ctx.fillStyle="#0af";ctx.strokeStyle="#fff";ctx.lineWidth=1.5;ctx.beginPath();ctx.moveTo(0,-sS*0.6);ctx.lineTo(sS*0.5,-sS*0.1);ctx.lineTo(sS*0.4,sS*0.5);ctx.lineTo(0,sS*0.7);ctx.lineTo(-sS*0.4,sS*0.5);ctx.lineTo(-sS*0.5,-sS*0.1);ctx.closePath();ctx.fill();ctx.stroke();}else{ctx.fillStyle="#fff";ctx.font=`bold ${cS*1.2}px VT323`;ctx.textAlign="center";ctx.textBaseline="middle";ctx.fillText(tC,0,1);}ctx.restore();}
        }

        // --- Classe Crystal (NUOVA Implementazione Esagonale) ---
        class Crystal {
             constructor(x, y, type = 0) { this.x=x;this.y=y;this.type=type; switch(this.type){case 1:this.width=20;this.height=20;this.value=250;this.speed=80+Math.random()*25;this.color={primary:"rgba(46,204,113,0.8)",secondary:"rgba(39,174,96,0.6)",highlight:"rgba(200,255,213,0.9)",glow:"#6de896"};break; case 2:this.width=25;this.height=25;this.value=500;this.speed=70+Math.random()*20;this.color={primary:"rgba(230,126,34,0.8)",secondary:"rgba(211,84,0,0.6)",highlight:"rgba(255,224,178,0.9)",glow:"#f5ab6e"};break; case 3:this.width=30;this.height=30;this.value=1000;this.speed=60+Math.random()*15;this.color={primary:"rgba(155,89,182,0.8)",secondary:"rgba(142,68,173,0.6)",highlight:"rgba(225,190,231,0.9)",glow:"#c39bd3"};break; default:this.width=15;this.height=15;this.value=100;this.speed=90+Math.random()*30;this.color={primary:"rgba(52,152,219,0.8)",secondary:"rgba(41,128,185,0.6)",highlight:"rgba(179,229,252,0.9)",glow:"#6ab7ff"};break;} this.active=true;this.rotationAngle=Math.random()*Math.PI*2;this.rotationSpeed=(Math.random()-0.5)*0.05;this.pulseSize=0;this.pulseSpeed=0.08+Math.random()*0.04;this.innerPulse=0;this.innerPulseSpeed=0.05+Math.random()*0.03;this.reflections=[];this.generateReflections();this.isBeingAttracted=false;this.attractionSpeed=0;this.maxAttractionSpeed=500;this.attractionAcceleration=2000; }
             generateReflections() { const c=2+Math.floor(Math.random()*3);this.reflections=[];for(let i=0;i<c;i++){this.reflections.push({x:(Math.random()-0.5)*0.6,y:(Math.random()-0.5)*0.6,size:0.1+Math.random()*0.3,angle:Math.random()*Math.PI*2,speed:0.01+Math.random()*0.03});} }
             update(deltaTime, playerShip) { if(!this.active)return; const dtS=deltaTime/1000; this.pulseSize=Math.sin(game.animationFrame*this.pulseSpeed)*2;this.rotationAngle+=this.rotationSpeed*dtS*60;this.innerPulse=0.7+Math.sin(game.animationFrame*this.innerPulseSpeed)*0.3; for(let r of this.reflections)r.angle+=r.speed*dtS*60; const ATTRACTION_RADIUS=150; if(playerShip&&playerShip.isAlive){ const dx=(playerShip.x+playerShip.width/2)-(this.x+this.width/2);const dy=(playerShip.y+playerShip.height/2)-(this.y+this.height/2);const dSq=dx*dx+dy*dy; if(dSq<ATTRACTION_RADIUS*ATTRACTION_RADIUS){this.isBeingAttracted=true;const dist=Math.sqrt(dSq);const dX=dx/dist;const dY=dy/dist;this.attractionSpeed=Math.min(this.attractionSpeed+this.attractionAcceleration*dtS,this.maxAttractionSpeed);const proxF=1-(dist/ATTRACTION_RADIUS);const curS=this.attractionSpeed*proxF;this.x+=dX*curS*dtS;this.y+=dY*curS*dtS; if(isColliding(this,playerShip)){this.active=false;game.score+=this.value;createCrystalCollectEffect(this.x+this.width/2,this.y+this.height/2,this.color);playCrystalCollectSound(this.type);return;}}else{this.isBeingAttracted=false;this.attractionSpeed=0;this.y+=this.speed*dtS;}}else{this.y+=this.speed*dtS;} if(this.y>canvas.height+this.height){this.active=false;} }
             draw(ctx) { if(!this.active||!ctx)return;ctx.save();ctx.translate(this.x+this.width/2,this.y+this.height/2);ctx.rotate(this.rotationAngle);const size=this.width+this.pulseSize;ctx.shadowColor=this.color.glow;ctx.shadowBlur=15+this.pulseSize;this.drawHexCrystal(ctx,size);ctx.shadowBlur=0;ctx.restore(); if(this.isBeingAttracted){ctx.save();const alpha=Math.min(1.0,this.attractionSpeed/this.maxAttractionSpeed);ctx.strokeStyle=`rgba(255,255,255,${alpha*0.4})`;ctx.lineWidth=1;ctx.setLineDash([5,5]);ctx.beginPath();ctx.moveTo(this.x+this.width/2,this.y+this.height/2);ctx.lineTo(spaceship.x+spaceship.width/2,spaceship.y+spaceship.height/2);ctx.stroke();ctx.restore();} }
             drawHexCrystal(ctx, size) { const sides=6;const step=Math.PI*2/sides;const hS=size/2;ctx.beginPath();for(let i=0;i<sides;i++){const a=i*step-Math.PI/6;const x=Math.cos(a)*hS;const y=Math.sin(a)*hS;if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);}ctx.closePath();const grad=ctx.createRadialGradient(0,0,hS*this.innerPulse,0,0,hS);grad.addColorStop(0,this.color.primary);grad.addColorStop(0.7,this.color.secondary);grad.addColorStop(1,this.color.primary);ctx.fillStyle=grad;ctx.fill();ctx.strokeStyle=this.color.highlight;ctx.lineWidth=1.5;ctx.stroke();ctx.beginPath();ctx.moveTo(0,-hS);ctx.lineTo(0,hS);ctx.strokeStyle=this.color.highlight+"60";ctx.lineWidth=1;ctx.stroke();ctx.beginPath();ctx.moveTo(-hS*0.866,-hS*0.5);ctx.lineTo(hS*0.866,hS*0.5);ctx.strokeStyle=this.color.highlight+"50";ctx.lineWidth=0.5;ctx.stroke();ctx.beginPath();ctx.moveTo(-hS*0.866,hS*0.5);ctx.lineTo(hS*0.866,-hS*0.5);ctx.stroke();for(let r of this.reflections){const rx=r.x*hS;const ry=r.y*hS;const rs=r.size*hS;ctx.beginPath();ctx.arc(rx,ry,rs,0,Math.PI*2);const rG=ctx.createRadialGradient(rx,ry,0,rx,ry,rs);rG.addColorStop(0,this.color.highlight);rG.addColorStop(1,"rgba(255,255,255,0)");ctx.fillStyle=rG;ctx.fill();}const sC=2+Math.floor(this.type);for(let i=0;i<sC;i++){const a=(game.animationFrame*0.01+i*Math.PI*2/sC)%(Math.PI*2);const d=hS*0.7*Math.sin(game.animationFrame*0.03+i);const sx=Math.cos(a)*d*0.5;const sy=Math.sin(a)*d*0.5;ctx.fillStyle="rgba(255,255,255,0.8)";ctx.beginPath();ctx.arc(sx,sy,1+Math.random(),0,Math.PI*2);ctx.fill();}}
        }

        // --- Classe Planet ---
        class Planet {
             constructor(x,y,s,t,d){ this.x=x;this.y=y;this.size=s;this.type=t;this.depth=d;this.speed=starSpeed*(.18+d*.22);this.featureSeed=Math.floor(pseudoRandom()*1e4);this.rotationAngle=pseudoRandom()*Math.PI*2;this.rotationSpeed=(pseudoRandom()-.5)*4e-4*(1/(this.speed+.1));this.active=true;}
             update(deltaTime){ if(!this.active)return false; const dtR=deltaTime/(1000/60); this.y+=this.speed*dtR; this.rotationAngle+=this.rotationSpeed*dtR; if(this.y-this.size>canvas.height){this.active=false; const i=currentPlanetTypes.indexOf(this.type); if(i>-1)currentPlanetTypes.splice(i,1);} return this.active;}
             draw(){ if(!this.active||!isFinite(this.x)||!isFinite(this.y)||!isFinite(this.size)||this.size<=0||!ctx)return; ctx.save(); ctx.globalAlpha=0.5+(1-this.depth)*0.5; ctx.translate(this.x,this.y); ctx.rotate(this.rotationAngle); let bC,lC,dC,crC,crS,crH; switch(this.type){case 0:bC="rgb(30,70,130)";lC="rgb(70,130,180)";dC="rgb(20,50,100)";crS="rgba(100,160,210,0.8)";crC="rgba(15,35,65,0.6)";crH="rgba(180,210,240,0.6)";break; case 6:bC="rgb(40,120,60)";lC="rgb(100,180,100)";dC="rgb(20,80,40)";crS="rgba(130,200,140,0.8)";crC="rgba(15,60,30,0.6)";crH="rgba(180,220,190,0.6)";break; case 7:bC="rgb(80,10,10)";lC="rgb(120,30,30)";dC="rgb(60,5,5)";crS="rgba(150,40,40,0.8)";crC="rgba(40,5,5,0.6)";crH="rgba(180,60,60,0.6)";break; case 8:bC="rgb(80,30,130)";lC="rgb(130,70,180)";dC="rgb(50,20,100)";crS="rgba(160,100,210,0.8)";crC="rgba(40,15,65,0.6)";crH="rgba(200,150,240,0.6)";break; default:bC="rgb(50,50,50)";lC="rgb(100,100,100)";dC="rgb(30,30,30)";crS="rgba(140,140,140,0.8)";crC="rgba(20,20,20,0.6)";crH="rgba(180,180,180,0.6)";break;} try{const g=ctx.createRadialGradient(-this.size*0.3,-this.size*0.4,this.size*0.1,0,0,this.size);g.addColorStop(0,lC);g.addColorStop(0.6,bC);g.addColorStop(1,dC);ctx.fillStyle=g;ctx.beginPath();ctx.arc(0,0,this.size,0,2*Math.PI);ctx.fill();}catch(e){ctx.restore();return;} const rand=seededPseudoRandom(this.featureSeed);const nC=4+Math.floor(rand()*6);for(let i=0;i<nC;i++){const a=rand()*Math.PI*2;const r=rand()*this.size*0.85;const cx=Math.cos(a)*r;const cy=Math.sin(a)*r;const cS=this.size*(0.04+rand()*0.12);const cresA=a+Math.PI+(rand()-0.5)*0.4;ctx.save();ctx.translate(cx,cy);ctx.fillStyle=crC;ctx.beginPath();ctx.arc(0,0,cS,0,2*Math.PI);ctx.fill();ctx.strokeStyle=crH;ctx.lineWidth=Math.max(0.5,cS*0.15+rand()*cS*0.1);ctx.lineCap="round";ctx.beginPath();ctx.arc(0,0,cS*0.92,cresA-Math.PI*0.5,cresA+Math.PI*0.5);ctx.stroke();ctx.strokeStyle=crS;ctx.beginPath();ctx.arc(0,0,cS*0.9,cresA+Math.PI*0.5,cresA+Math.PI*1.5);ctx.stroke();if(cS>this.size*0.1&&rand()>0.4){ctx.fillStyle=crH+"99";ctx.beginPath();ctx.arc(0,0,cS*0.2,0,2*Math.PI);ctx.fill();}ctx.restore();} const hG=ctx.createRadialGradient(0,0,this.size*0.9,0,0,this.size*1.1);hG.addColorStop(0,"rgba(255,255,255,0)");try{hG.addColorStop(0.5,hexToRgba(lC,0.05));}catch{hG.addColorStop(0.5,"rgba(200,200,200,0.05)");}hG.addColorStop(1,"rgba(255,255,255,0)");ctx.fillStyle=hG;ctx.beginPath();ctx.arc(0,0,this.size*1.1,0,2*Math.PI);ctx.fill();ctx.restore();}
        }

        // --- Classe Boss ---
        class Boss {
             constructor() { this.x=canvas.width/2;this.y=-250;this.width=280;this.height=220;this.active=false;this.isEntering=true;this.targetY=100;this.entrySpeed=70;this.moveSpeed=45;this.direction=1;this.phase=0;this.phaseChangeFlash=0;this.attackCooldown=2000;this.isVisible=false;this.colors={primary:"#600",secondary:"#a00",accent:"#fcc",glow:"#f00",energy:"#f88",shield:"#8ff"}; this.components={'mainBody':{name:"Corpo",x:0,y:0,width:this.width,height:this.height,health:9999,maxHealth:9999,active:true,isCore:false,draw:this.drawMainBody.bind(this),isHittable:false},'shieldGenerator':{name:"Generatore Scudo",x:0,y:-this.height*0.4,width:80,height:40,health:150,maxHealth:150,active:true,isCore:false,shieldActive:true,shieldRadius:this.width*0.65,shieldPulse:0,draw:this.drawShieldGenerator.bind(this),isHittable:true},'leftTurret':{name:"Torretta Sinistra",x:-this.width*0.30,y:-this.height*0.1,width:60,height:60,health:180,maxHealth:180,active:true,isCore:false,cooldown:3000,timer:3000,draw:this.drawTurret.bind(this,-1),isHittable:true},'rightTurret':{name:"Torretta Destra",x:this.width*0.30,y:-this.height*0.1,width:60,height:60,health:180,maxHealth:180,active:true,isCore:false,cooldown:3000,timer:3000,draw:this.drawTurret.bind(this,1),isHittable:true},'core':{name:"Nucleo",x:0,y:this.height*0.35,width:70,height:50,health:400,maxHealth:400,active:false,isCore:true,draw:this.drawCore.bind(this),isHittable:false}}; this.totalMaxHealth=Object.values(this.components).filter(c=>c.isHittable).reduce((s,c)=>s+c.maxHealth,0);this.currentTotalHealth=this.totalMaxHealth; this.attackPatterns=[{name:"Turret Fire",minPhase:0,execute:()=>{},internal:true},{name:"Laser Sweep",minPhase:0,cooldown:6000,timer:0,execute:this.laserSweep.bind(this)},{name:"Missile Volley",minPhase:1,cooldown:8000,timer:0,execute:this.missileVolley.bind(this)},{name:"Mine Field",minPhase:1,cooldown:14000,timer:0,execute:this.mineField.bind(this)},{name:"Beam Cannon",minPhase:2,cooldown:10000,timer:0,execute:this.beamCannon.bind(this)},{name:"Summon Reinforcements",minPhase:1,cooldown:18000,timer:0,execute:this.summonReinforcements.bind(this)}]; }
             spawn() { this.active=true;this.isVisible=true;this.isEntering=true;this.y=-this.height*1.5;game.bossSpawned=true;console.log("BOSS SPAWN!");if(AudioSystem){AudioSystem.stopAllMP3Music(500);setTimeout(()=>{if(this.active&&game.bossSpawned)AudioSystem.playBossMP3();},600);}if(bossHealthBarContainer)bossHealthBarContainer.style.display='block';this.updateTotalHealth();}
             update(deltaTime) { if(!this.active)return;const dtS=deltaTime/1000;if(this.isEntering){this.y+=this.entrySpeed*dtS;if(this.y>=this.targetY){this.y=this.targetY;this.isEntering=false;this.determinePhase();console.log("Boss in pos.");}return;}this.x+=this.moveSpeed*this.direction*dtS;const hW=this.width/2;if((this.direction>0&&this.x+hW>canvas.width-20)||(this.direction<0&&this.x-hW<20)){this.direction*=-1;this.x+=this.moveSpeed*this.direction*dtS*2;this.x=Math.max(20+hW,Math.min(canvas.width-20-hW,this.x));}const oP=this.phase;this.determinePhase();if(this.phase>oP){this.phaseChangeFlash=300;if(AudioSystem)AudioSystem.playShieldUpSound();console.log(`Boss Fase ${this.phase+1}`);this.moveSpeed*=1.15;this.components.leftTurret.timer=this.components.leftTurret.cooldown*0.5;this.components.rightTurret.timer=this.components.rightTurret.cooldown*0.5;}if(this.phaseChangeFlash>0)this.phaseChangeFlash-=deltaTime;this.attackCooldown-=deltaTime;Object.values(this.components).forEach(c=>{if(c.timer>0)c.timer-=deltaTime;});this.attackPatterns.forEach(p=>{if(p.timer>0)p.timer-=deltaTime;});this.handleComponentAttacks(deltaTime);if(this.attackCooldown<=0){this.executeAttackPattern();this.attackCooldown=(1500+Math.random()*2000)/(1+this.phase*0.1);}if(this.components.shieldGenerator.shieldActive)this.components.shieldGenerator.shieldPulse=Math.sin(game.animationFrame*0.08)*4;}
             handleComponentAttacks(deltaTime) { const lT=this.components.leftTurret;if(lT.active&&lT.timer<=0){this.fireTurretLaser(lT.x,lT.y+lT.height*0.3);lT.timer=lT.cooldown*(0.8+Math.random()*0.4)/(1+this.phase*0.2);}const rT=this.components.rightTurret;if(rT.active&&rT.timer<=0){this.fireTurretLaser(rT.x,rT.y+rT.height*0.3);rT.timer=rT.cooldown*(0.8+Math.random()*0.4)/(1+this.phase*0.2);}}
             executeAttackPattern() { const avail=this.attackPatterns.filter(p=>this.phase>=p.minPhase&&!p.internal&&p.timer<=0);if(avail.length>0){const p=avail[Math.floor(Math.random()*avail.length)];console.log(`Boss attack: ${p.name}`);p.execute();p.timer=p.cooldown/(1+this.phase*0.15);}else{this.attackCooldown=500;}}
             fireTurretLaser(oX, oY) { const pX=this.x+oX;const pY=this.y+oY;const sp=300+Math.random()*60+this.phase*20;const tr=0.05+this.phase*0.03;game.alienProjectiles.push(new AlienProjectile(pX,pY,sp,8,this.colors.energy,tr));if(AudioSystem)AudioSystem.playAlienLaserSound();}
             laserSweep() { const swA=Math.PI/2.5;const nS=9+this.phase*2;const aS=swA/(nS-1);const stA=-swA/2;const oY=this.y+this.components.mainBody.height*0.2;const shD=Math.max(30,60-this.phase*10);for(let i=0;i<nS;i++){setTimeout(()=>{if(!this.active)return;const ang=stA+i*aS;const pX=this.x+Math.cos(ang+Math.PI/2)*30;const pY=oY+Math.sin(ang+Math.PI/2)*30;const sp=350+this.phase*25;const pr=new AlienProjectile(pX,pY,0,6,this.colors.energy);pr.speedX=Math.cos(ang+Math.PI/2)*sp;pr.speedY=Math.sin(ang+Math.PI/2)*sp;game.alienProjectiles.push(pr);},i*shD);}if(AudioSystem)AudioSystem.playSpreadSound();}
             missileVolley() { const nM=3+Math.floor(this.phase);const oY=this.y+this.components.mainBody.height*0.4;const mD=Math.max(150,250-this.phase*40);for(let i=0;i<nM;i++){setTimeout(()=>{if(!this.active)return;const pX=this.x+(Math.random()-0.5)*this.width*0.6;game.alienProjectiles.push(new AlienProjectile(pX,oY,220,10,this.colors.secondary,0.3+this.phase*0.1));if(AudioSystem)AudioSystem.playHeavySound();},i*mD);}}
             mineField() { const nM=4+this.phase;const spr=this.width*0.7;for(let i=0;i<nM;i++){const mX=this.x+(Math.random()-0.5)*spr;const mY=this.y+this.height*0.6+Math.random()*80;const mine=new AlienProjectile(mX,mY,20,12,this.colors.primary);mine.speedY=20+Math.random()*10;mine.speedX=(Math.random()-0.5)*30;mine.lifeTimer=5000+Math.random()*2000;mine.trackingFactor=0;mine.damage=ALIEN_COLLISION_DAMAGE+3; mine.update=function(dtM){if(!this.active)return;const dtS=dtM/1000;this.lifeTimer-=dtM;if(this.lifeTimer<=0){this.explode();return;}this.x+=this.speedX*dtS;this.y+=this.speedY*dtS;if(spaceship.isAlive&&!spaceship.shieldActive&&isColliding(this,spaceship)){this.explode();spaceship.takeDamage(this.damage);}if(this.y>canvas.height+this.height||this.x<-this.width||this.x>canvas.width+this.width){this.active=false;}}; mine.explode=function(){if(!this.active)return;this.active=false;game.explosions.push(new Explosion(this.x,this.y,60,{primary:this.color,energy:'#ffccaa'},'medium'));if(AudioSystem)AudioSystem.playExplosionSound('medium');}; game.alienProjectiles.push(mine);}}
             beamCannon() { if(!this.components.core.active||!this.components.core.isHittable){console.log("WARN: Beam ma nucleo non pronto.");return;}console.log("Boss spara: BEAM CANNON!");const bD=1500+this.phase*200;const bW=25+this.phase*5;const bX=this.x+this.components.core.x;const bSY=this.y+this.components.core.y+this.components.core.height/2;if(AudioSystem)AudioSystem.startContinuous();const bE=new Explosion(bX,bSY,0,{type:'beam',life:bD,startTime:Date.now(),colors:this.colors,width:bW,dps:LASER_DPS*(1+this.phase*0.25),bossRef:this}); bE.drawBeam=(ctxB)=>{if(!bE.active||!ctxB)return;const el=Date.now()-bE.startTime;if(el>=bE.life){bE.active=false;if(AudioSystem)AudioSystem.stopContinuous();return;}const cH=canvas.height-bE.y;const pu=Math.sin(el*0.02)*3*(1+bE.bossRef.phase*0.5);const cW=bE.colors.width+pu;const al=0.8*(1-(el/(bE.life*1.2)));ctxB.save();ctxB.globalAlpha=Math.max(0,al);const g=ctxB.createLinearGradient(bE.x,bE.y,bE.x,bE.y+cH);try{g.addColorStop(0,bE.colors.accent+"FF");g.addColorStop(0.1,bE.colors.energy+"EE");g.addColorStop(0.7,bE.colors.primary+"BB");g.addColorStop(1,bE.colors.primary+"33");}catch{g.addColorStop(0,"#fff");g.addColorStop(1,bE.colors.primary+"33");}ctxB.fillStyle=g;ctxB.fillRect(bE.x-cW/2,bE.y,cW,cH);const lR={x:bE.x-cW/2,y:bE.y,width:cW,height:cH};if(spaceship.isAlive&&!spaceship.shieldActive&&isColliding(lR,spaceship)){const d=bE.dps*(game.deltaTime/1000);spaceship.takeDamage(d);}ctxB.restore();}; game.explosions.push(bE);}
             summonReinforcements() { const nS=1+this.phase;console.log(`Boss evoca ${nS} guardie elite`);for(let i=0;i<nS;i++){const sX=this.x+(i%2===0?-1:1)*(this.width*0.6+Math.random()*30);const sY=this.y-50;const p={health:3*(1+this.phase*0.5),speedY:100+10*this.phase,shootCooldown:Math.max(800,1900-300*this.phase),movement:'sine',speedFactor:1.1,sineAmplitude:80+Math.random()*20,sineFrequency:0.022+(Math.random()-0.5)*0.005,isElite:true};const gC=window.alienColorSchemes[3];game.aliens.push(new Alien(sX,sY,30,gC,p.movement,p));}}
             updateTotalHealth() { if(!bossHealthBar||!bossHealthText)return;this.currentTotalHealth=Object.values(this.components).filter(c=>c.isHittable&&c.active).reduce((s,c)=>s+Math.max(0,c.health),0);if(this.components.core.isHittable&&this.components.core.active)this.currentTotalHealth+=Math.max(0,this.components.core.health);let cMH=Object.values(this.components).filter(c=>c.isHittable&&c.active).reduce((s,c)=>s+c.maxHealth,0);if(this.components.core.isHittable&&this.components.core.active)cMH+=this.components.core.maxHealth;if(cMH===0)cMH=this.totalMaxHealth;const hP=(this.totalMaxHealth>0)?Math.max(0,this.currentTotalHealth)/this.totalMaxHealth:0;bossHealthBar.style.width=`${hP*100}%`;bossHealthText.textContent=`CMDR SCUDERI (${Math.round(hP*100)}%)`;}
             determinePhase() { const sG=this.components.shieldGenerator;const lT=this.components.leftTurret;const rT=this.components.rightTurret;const c=this.components.core;let nP=0;if(!sG.active){nP=1;if(!lT.active&&!rT.active){nP=2;if(!c.active&&!c.isHittable){console.log("NUCLEO ESPOSTO!");c.active=true;c.isHittable=true;this.totalMaxHealth=Object.values(this.components).filter(c=>c.maxHealth<9000).reduce((s,c)=>s+c.maxHealth,0);this.updateTotalHealth();game.uiMessage="NUCLEO ESPOSTO!";game.uiMessageTimer=2500;if(uiMessageDisplay){uiMessageDisplay.style.color="#ff8888";uiMessageDisplay.textContent=game.uiMessage;uiMessageDisplay.classList.add('visible');}}}}}this.phase=nP;}
             takeDamage(amount, hitX, hitY) { if(!this.active||this.isEntering)return;let cHit=null;let dM=1.0;const sG=this.components.shieldGenerator;if(sG.active&&sG.shieldActive){const dx=hitX-(this.x+sG.x);const dy=hitY-(this.y+sG.y);if(dx*dx+dy*dy<sG.shieldRadius*sG.shieldRadius){cHit=sG;dM=0.7;game.explosions.push(new Explosion(hitX,hitY,20,{primary:this.colors.shield,energy:"#fff"},'small'));AudioSystem.playShieldDownSound();}}if(!cHit){for(const k in this.components){const c=this.components[k];if(!c.active||!c.isHittable||c===sG)continue;const cL=this.x+c.x-c.width/2;const cT=this.y+c.y-c.height/2;const cR=cL+c.width;const cB=cT+c.height;if(hitX>=cL&&hitX<=cR&&hitY>=cT&&hitY<=cB){cHit=c;dM=1.0;break;}}}if(cHit){const aD=amount*dM;cHit.health-=aD;game.explosions.push(new Explosion(hitX,hitY,15,{primary:"#fff",energy:"#ffccaa"},'small'));if(cHit.health<=0&&cHit.active){cHit.health=0;cHit.active=false;console.log(`Boss: ${cHit.name} distrutto!`);game.explosions.push(new Explosion(this.x+cHit.x,this.y+cHit.y,cHit.width*1.5,this.colors,'medium'));AudioSystem.playExplosionSound('medium');if(cHit===sG){sG.shieldActive=false;console.log("Boss: SCUDO OFF!");game.uiMessage="SCUDO DISTRUTTO!";game.uiMessageTimer=2000;if(uiMessageDisplay){uiMessageDisplay.style.color="#ffff88";uiMessageDisplay.textContent=game.uiMessage;uiMessageDisplay.classList.add('visible');}}else if(cHit===this.components.core){this.defeat();return;}this.determinePhase();}this.updateTotalHealth();}}
             defeat() { if(!this.active)return;this.active=false;this.isVisible=false;game.bossSpawned=false;game.bossDefeated=true;console.log("BOSS SCONFITTO!");game.score+=15000;if(bossHealthBarContainer)bossHealthBarContainer.style.display='none';createBossExplosion(this.x,this.y,this.width*1.5);if(AudioSystem){AudioSystem.playMegaExplosionSound();AudioSystem.stopAllMP3Music(1000);}setTimeout(()=>{if(!game.isGameOver)gameOver(true);},5500);}
             drawMainBody(ctx) { if(!ctx||!this.components.mainBody.active)return;const c=this.components.mainBody;ctx.save();ctx.translate(this.x+c.x,this.y+c.y);const g=ctx.createLinearGradient(0,-c.height*0.5,0,c.height*0.5);g.addColorStop(0,this.colors.secondary);g.addColorStop(0.5,this.colors.primary);g.addColorStop(1,"#400");ctx.fillStyle=g;ctx.beginPath();ctx.moveTo(0,-c.height*0.5);ctx.bezierCurveTo(c.width*0.4,-c.height*0.55,c.width*0.45,-c.height*0.1,c.width*0.5,0);ctx.bezierCurveTo(c.width*0.48,c.height*0.3,c.width*0.2,c.height*0.45,0,c.height*0.5);ctx.bezierCurveTo(-c.width*0.2,c.height*0.45,-c.width*0.48,c.height*0.3,-c.width*0.5,0);ctx.bezierCurveTo(-c.width*0.45,-c.height*0.1,-c.width*0.4,-c.height*0.55,0,-c.height*0.5);ctx.closePath();ctx.fill();ctx.strokeStyle=this.colors.glow;ctx.lineWidth=1.5;ctx.stroke();if(this.phaseChangeFlash>0&&Math.floor(this.phaseChangeFlash/50)%2===0){ctx.fillStyle="rgba(255,255,255,0.5)";ctx.fill();}ctx.restore();}
             drawTurret(side, ctx) { if(!ctx)return;const c=(side===-1)?this.components.leftTurret:this.components.rightTurret;ctx.save();ctx.translate(this.x+c.x,this.y+c.y);if(!c.active){ctx.fillStyle="#333";ctx.strokeStyle="#666";ctx.lineWidth=2;ctx.beginPath();ctx.arc(0,0,c.width*0.3,0,Math.PI*2);ctx.fill();ctx.stroke();for(let i=0;i<3;i++){ctx.beginPath();ctx.moveTo(0,0);const a=Math.random()*Math.PI*2;ctx.lineTo(Math.cos(a)*c.width*0.3,Math.sin(a)*c.width*0.3);ctx.stroke();}ctx.restore();return;}const eS=c.width*0.8;const pS=eS*0.4;const pP=Math.sin(game.animationFrame*0.1+side*5)*pS*0.1;const gG=ctx.createRadialGradient(0,0,pS*0.5,0,0,eS*0.8);try{gG.addColorStop(0,hexToRgba(this.colors.energy,1.0));gG.addColorStop(0.6,hexToRgba(this.colors.glow,0.53));gG.addColorStop(1,hexToRgba(this.colors.glow,0));}catch{gG.addColorStop(0,this.colors.energy);gG.addColorStop(1,this.colors.glow+"00");}ctx.fillStyle=gG;ctx.beginPath();ctx.arc(0,0,eS*0.8,0,Math.PI*2);ctx.fill();ctx.fillStyle="#111";ctx.beginPath();ctx.arc(0,0,eS*0.5,0,Math.PI*2);ctx.fill();ctx.fillStyle=this.colors.primary;ctx.beginPath();ctx.arc(0,0,pS+pP,0,Math.PI*2);ctx.fill();try{ctx.fillStyle=hexToRgba(this.colors.accent,0.6);}catch{ctx.fillStyle=this.colors.accent+"99";}ctx.beginPath();ctx.arc(eS*0.15,-eS*0.15,pS*0.2,0,Math.PI*2);ctx.fill();const hp=c.health/c.maxHealth;const bW=c.width;const bH=6;const bY=c.height*0.55;ctx.fillStyle="rgba(50,0,0,0.7)";ctx.fillRect(-bW/2,bY,bW,bH);ctx.fillStyle=hp>0.5?"#f44":hp>0.2?"#f84":"#f00";ctx.fillRect(-bW/2,bY,bW*hp,bH);ctx.restore();}
             drawShieldGenerator(ctx) { if(!ctx)return;const c=this.components.shieldGenerator;ctx.save();ctx.translate(this.x+c.x,this.y+c.y);if(!c.active){ctx.fillStyle="#444";ctx.strokeStyle="#888";ctx.lineWidth=1;ctx.strokeRect(-c.width/2,-c.height/2,c.width,c.height);ctx.beginPath();ctx.moveTo(-c.width*0.4,-c.height*0.3);ctx.lineTo(c.width*0.4,c.height*0.3);ctx.stroke();ctx.beginPath();ctx.moveTo(c.width*0.4,-c.height*0.3);ctx.lineTo(-c.width*0.4,c.height*0.3);ctx.stroke();ctx.restore();return;}const cP=6;const aS=Math.PI*2/cP;const oR=c.width*0.45;const iR=oR*0.5;ctx.fillStyle=c.shieldActive?this.colors.shield:"#668888";ctx.strokeStyle="#fff";ctx.lineWidth=1;ctx.beginPath();for(let i=0;i<cP;i++){ctx.lineTo(Math.cos(aS*i)*oR,Math.sin(aS*i)*oR);ctx.lineTo(Math.cos(aS*i+aS/2)*iR,Math.sin(aS*i+aS/2)*iR);}ctx.closePath();ctx.fill();ctx.stroke();if(c.shieldActive){ctx.save();ctx.translate(-c.x,-c.y);ctx.globalAlpha=0.3+Math.sin(game.animationFrame*0.05)*0.1;const sG=ctx.createRadialGradient(0,0,c.shieldRadius*0.1,0,0,c.shieldRadius+c.shieldPulse);try{sG.addColorStop(0,hexToRgba(this.colors.shield,0.07));sG.addColorStop(0.8,hexToRgba(this.colors.shield,0.4));sG.addColorStop(1,hexToRgba(this.colors.shield,0.07));}catch{sG.addColorStop(0.8,this.colors.shield+"66");sG.addColorStop(1,this.colors.shield+"11");}ctx.fillStyle=sG;ctx.beginPath();ctx.arc(0,0,c.shieldRadius+c.shieldPulse,0,Math.PI*2);ctx.fill();ctx.restore();}ctx.restore();}
             drawCore(ctx) { if(!ctx||!this.components.core.active)return;const c=this.components.core;ctx.save();ctx.translate(this.x+c.x,this.y+c.y);const pF=0.9+Math.sin(game.animationFrame*0.1)*0.1;const cW=c.width*pF;const cH=c.height*pF;const gG=ctx.createRadialGradient(0,0,0,0,0,cW*0.7);gG.addColorStop(0,this.colors.accent+"CC");gG.addColorStop(0.5,this.colors.energy+"AA");gG.addColorStop(1,this.colors.primary+"00");ctx.fillStyle=gG;ctx.fillRect(-cW/2,-cH/2,cW,cH);try{ctx.fillStyle=hexToRgba(this.colors.accent,0.6+Math.sin(game.animationFrame*0.15)*0.2);}catch{ctx.fillStyle=`rgba(255,200,200,${0.6+Math.sin(game.animationFrame*0.15)*0.2})`;}ctx.fillRect(-cW*0.4,-cH*0.4,cW*0.8,cH*0.8);if(c.isHittable){const hp=c.health/c.maxHealth;const bW=c.width*1.2;const bH=8;const bY=c.height*0.6;ctx.fillStyle="rgba(50,0,0,0.8)";ctx.fillRect(-bW/2,bY,bW,bH);ctx.fillStyle=hp>0.5?"#f44":hp>0.2?"#f84":"#f00";ctx.fillRect(-bW/2,bY,bW*hp,bH);}ctx.restore();}
             draw(ctx) { if (!this.active || !this.isVisible || !ctx) return; this.components.mainBody.draw(ctx); this.components.leftTurret.draw(ctx); this.components.rightTurret.draw(ctx); this.components.shieldGenerator.draw(ctx); this.components.core.draw(ctx); }
        }

        // --- Funzioni Logica Cristalli (NUOVA IMPLEMENTAZIONE) ---
        function createCrystalCollectEffect(x, y, color) { const eC={primary:color.primary,secondary:color.secondary,accent:"#ffffff",glow:color.glow,energy:color.highlight}; game.explosions.push(new Explosion(x,y,25,eC,"small")); }
        function playCrystalCollectSound(type) { AudioSystem.playCrystalSound(type); }
        function spawnCrystalsFromAlien(alien) { let count=0; let types=[]; const pwr=alien.size*alien.maxHealth; if(pwr<70){if(Math.random()<0.35){count=1;types=[0];}}else if(pwr<150){const r=Math.random();if(r<0.5){count=1;types=[0];}else if(r<0.7){count=1;types=[1];}}else if(pwr<300){const r=Math.random();if(r<0.3){count=1;types=[1];}else if(r<0.6){count=2;types=[0,0];}else if(r<0.8){count=1;types=[2];}}else{const r=Math.random();if(r<0.3){count=2;types=[1,0];}else if(r<0.6){count=1;types=[2];}else if(r<0.85){count=2;types=[1,1];}else{count=1;types=[3];}} if(alien.isElite&&Math.random()<0.5){count++;types.push(Math.floor(Math.random()*2));} if(!game.crystals)game.crystals=[]; for(let i=0;i<count;i++){const oX=(Math.random()-0.5)*alien.size*0.5;const oY=(Math.random()-0.5)*alien.size*0.5;game.crystals.push(new Crystal(alien.x+oX,alien.y+oY,types[i]??0));}}
        function updateCrystals(deltaTime) { if(!game.crystals)return; for(let i=game.crystals.length-1;i>=0;i--){ game.crystals[i].update(deltaTime,spaceship); if(!game.crystals[i].active)game.crystals.splice(i,1);} }
        function drawCrystals(ctx) { if (!game.crystals || !ctx) return; for (let crystal of game.crystals) crystal.draw(ctx); }

    </script>
    <!-- === FINE BLOCCO 5 === -->
    <!-- === INSERISCI QUI IL BLOCCO 6 (JavaScript Game Logic Functions) === -->
  
    <!-- === INIZIO BLOCCO 6 (JavaScript Game Logic Functions) === -->
    <script>
        // --- Funzioni di Disegno Specifiche ---

        // Disegna logo Condorspace (basato su RaptorXLogo)
        function drawCondorspaceTitleLogo(canvasElement) {
            // --- Implementazione drawCondorspaceTitleLogo dal Blocco 5 precedente ---
            if (!canvasElement) return; const ctxLogo = canvasElement.getContext('2d'); if (!ctxLogo) return; const w = canvasElement.width; const h = canvasElement.height; ctxLogo.clearRect(0, 0, w, h); const scale = Math.min(w / 100, h / 80); const cX = w / 2; const cY = h / 2 + h * 0.05; ctxLogo.save(); ctxLogo.translate(cX, cY); ctxLogo.scale(scale, scale); ctxLogo.beginPath(); ctxLogo.fillStyle = '#2a4b8d'; ctxLogo.moveTo(0,-35); ctxLogo.lineTo(-25,25); ctxLogo.lineTo(25,25); ctxLogo.closePath(); ctxLogo.fill(); ctxLogo.strokeStyle = '#49daff'; ctxLogo.lineWidth = 2/scale; ctxLogo.stroke(); ctxLogo.beginPath(); ctxLogo.moveTo(-25,10); ctxLogo.lineTo(-45,30); ctxLogo.lineTo(-25,25); ctxLogo.closePath(); ctxLogo.fill(); ctxLogo.stroke(); ctxLogo.beginPath(); ctxLogo.moveTo(25,10); ctxLogo.lineTo(45,30); ctxLogo.lineTo(25,25); ctxLogo.closePath(); ctxLogo.fill(); ctxLogo.stroke(); ctxLogo.beginPath(); ctxLogo.moveTo(0,-25); ctxLogo.lineTo(-10,0); ctxLogo.lineTo(10,0); ctxLogo.closePath(); ctxLogo.fillStyle = '#6ab7ff'; ctxLogo.fill(); ctxLogo.stroke(); ctxLogo.fillStyle = '#ff9f1c'; ctxLogo.beginPath(); ctxLogo.moveTo(-15,25); ctxLogo.lineTo(-10,40); ctxLogo.lineTo(0,25); ctxLogo.closePath(); ctxLogo.fill(); ctxLogo.beginPath(); ctxLogo.moveTo(15,25); ctxLogo.lineTo(10,40); ctxLogo.lineTo(0,25); ctxLogo.closePath(); ctxLogo.fill(); ctxLogo.shadowColor = '#49daff'; ctxLogo.shadowBlur = 10/scale; ctxLogo.strokeStyle = 'rgba(73,218,255,0.6)'; ctxLogo.lineWidth = 1/scale; ctxLogo.beginPath(); ctxLogo.arc(0,0,60,0,Math.PI*2); ctxLogo.stroke(); ctxLogo.restore();
        }

        // Disegna navicella giocatore (da condor.html corretto)
        function drawSpaceship(){ if(!spaceship.isAlive||!isSpaceshipCurrentlyVisible()||!ctx)return;ctx.save();const cX=spaceship.x+spaceship.width/2;const cY=spaceship.y+spaceship.height/2;if(spaceship.shieldActive){const sMaxR=spaceship.width*0.8;const sPulse=Math.sin(game.animationFrame*0.08)*4;const cR=sMaxR+sPulse;const sAlpha=0.4+Math.sin(game.animationFrame*0.1)*0.15;const fadeF=Math.min(1,spaceship.shieldTimer/(spaceship.SHIELD_DURATION*0.3));ctx.globalAlpha=sAlpha*fadeF;const grad=ctx.createRadialGradient(cX,cY,cR*0.5,cX,cY,cR);grad.addColorStop(0,"rgba(180,220,255,0.1)");grad.addColorStop(0.7,"rgba(100,180,255,0.6)");grad.addColorStop(1,"rgba(50,120,200,0.3)");ctx.fillStyle=grad;ctx.beginPath();ctx.arc(cX,cY,cR,0,Math.PI*2);ctx.fill();ctx.strokeStyle=`rgba(200,230,255,${0.7*fadeF})`;ctx.lineWidth=1.5;ctx.beginPath();ctx.arc(cX,cY,cR,0,Math.PI*2);ctx.stroke();ctx.globalAlpha=1.0;}const sBG=ctx.createLinearGradient(spaceship.x,spaceship.y,spaceship.x+spaceship.width,spaceship.y+spaceship.height);sBG.addColorStop(0,"#1e5799");sBG.addColorStop(0.4,"#207cca");sBG.addColorStop(0.6,"#2989d8");sBG.addColorStop(1,"#1e5799");ctx.fillStyle=sBG;ctx.beginPath();ctx.moveTo(spaceship.x+spaceship.width*0.2,spaceship.y+15);ctx.bezierCurveTo(spaceship.x+spaceship.width*0.35,spaceship.y,spaceship.x+spaceship.width*0.65,spaceship.y,spaceship.x+spaceship.width*0.8,spaceship.y+15);ctx.lineTo(spaceship.x+spaceship.width,spaceship.y+spaceship.height*0.7);ctx.lineTo(spaceship.x+spaceship.width*0.8,spaceship.y+spaceship.height);ctx.lineTo(spaceship.x+spaceship.width*0.2,spaceship.y+spaceship.height);ctx.lineTo(spaceship.x,spaceship.y+spaceship.height*0.7);ctx.closePath();ctx.fill();const wG=ctx.createLinearGradient(spaceship.x-15,spaceship.y+spaceship.height*0.6,spaceship.x+15,spaceship.y+spaceship.height*0.8);wG.addColorStop(0,"#00356b");wG.addColorStop(0.5,"#1a6bbf");wG.addColorStop(1,"#3498db");const rWG=ctx.createLinearGradient(spaceship.x+spaceship.width+15,spaceship.y+spaceship.height*0.6,spaceship.x+spaceship.width-15,spaceship.y+spaceship.height*0.8);rWG.addColorStop(0,"#00356b");rWG.addColorStop(0.5,"#1a6bbf");rWG.addColorStop(1,"#3498db");ctx.fillStyle=wG;ctx.beginPath();ctx.moveTo(spaceship.x,spaceship.y+spaceship.height*0.7);ctx.lineTo(spaceship.x-20,spaceship.y+spaceship.height*0.85);ctx.lineTo(spaceship.x-10,spaceship.y+spaceship.height*0.95);ctx.lineTo(spaceship.x,spaceship.y+spaceship.height*0.9);ctx.closePath();ctx.fill();ctx.fillStyle=rWG;ctx.beginPath();ctx.moveTo(spaceship.x+spaceship.width,spaceship.y+spaceship.height*0.7);ctx.lineTo(spaceship.x+spaceship.width+20,spaceship.y+spaceship.height*0.85);ctx.lineTo(spaceship.x+spaceship.width+10,spaceship.y+spaceship.height*0.95);ctx.lineTo(spaceship.x+spaceship.width,spaceship.y+spaceship.height*0.9);ctx.closePath();ctx.fill();const eR=spaceship.width*0.28;const eY=spaceship.y+spaceship.height*0.35;ctx.fillStyle="#207cca";ctx.beginPath();ctx.arc(cX,eY,eR,0,Math.PI*2);ctx.fill();const eG=ctx.createRadialGradient(cX,eY,0,cX,eY,eR*0.85);eG.addColorStop(0,"#ffe066");eG.addColorStop(0.5,"#ff9f1c");eG.addColorStop(1,"#f77f00");ctx.fillStyle=eG;ctx.beginPath();ctx.arc(cX,eY,eR*0.85,0,Math.PI*2);ctx.fill();ctx.fillStyle="rgba(255,255,255,0.8)";ctx.beginPath();ctx.arc(cX+eR*0.4,eY-eR*0.3,eR*0.15,0,Math.PI*2);ctx.fill();ctx.fillStyle="rgba(255,255,255,0.6)";ctx.beginPath();ctx.arc(cX-eR*0.25,eY+eR*0.3,eR*0.1,0,Math.PI*2);ctx.fill();const nH=spaceship.height*0.18;const nW=spaceship.width*0.5;const nY=spaceship.y+spaceship.height*0.85;const nG=ctx.createLinearGradient(cX-nW/2,nY,cX+nW/2,nY+nH);nG.addColorStop(0,"#8899aa");nG.addColorStop(0.5,"#cdd0d4");nG.addColorStop(1,"#667788");ctx.fillStyle=nG;ctx.beginPath();ctx.moveTo(cX-nW/2,nY);ctx.lineTo(cX+nW/2,nY);ctx.lineTo(cX+nW*0.35,nY+nH);ctx.lineTo(cX-nW*0.35,nY+nH);ctx.closePath();ctx.fill();const thrustM=0.5+spaceship.thrustPower*0.8;const flSY=nY+nH*0.5;const flG=ctx.createLinearGradient(cX,flSY,cX,flSY+30*thrustM);flG.addColorStop(0,"#00ffff");flG.addColorStop(0.5,"#0066ff");flG.addColorStop(1,"rgba(0,40,255,0)");const flW=20*(0.8+Math.sin(spaceship.engineAnimFrame/2)*0.2)*thrustM;const flH=(20+10*spaceship.engineAnimFrame*0.8)*thrustM*1.5;if(thrustM>0.05&&flH>1){ctx.shadowColor="#0af";ctx.shadowBlur=10+10*spaceship.thrustPower;ctx.fillStyle=flG;ctx.beginPath();ctx.moveTo(cX-flW/2,flSY-5);ctx.quadraticCurveTo(cX,flSY+flH*1.5,cX+flW/2,flSY-5);ctx.closePath();ctx.fill();ctx.shadowBlur=0;}ctx.strokeStyle="#ff9f1c";ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(spaceship.x-15,spaceship.y+spaceship.height*0.75);ctx.lineTo(spaceship.x-5,spaceship.y+spaceship.height*0.85);ctx.stroke();ctx.beginPath();ctx.moveTo(spaceship.x+spaceship.width+15,spaceship.y+spaceship.height*0.75);ctx.lineTo(spaceship.x+spaceship.width+5,spaceship.y+spaceship.height*0.85);ctx.stroke();ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(cX,spaceship.y+spaceship.height*0.7);ctx.lineTo(cX,spaceship.y+spaceship.height*0.95);ctx.stroke();ctx.restore();}
        function drawProjectiles(t){ const a=game.animationFrame; for(let i of t) if(i.active) i.draw(a)}
        function drawAliens(){ for(let t of game.aliens) if(t.active) t.draw()}
        function drawPowerUps(){ for(let t of game.powerUps) if(t.active) t.draw()}
        function drawCrystals(){ if(game.crystals) for(let t of game.crystals) if(t.active) t.draw(ctx)}
        function drawExplosions(){ for(let t of game.explosions) if(t.active) t.draw(ctx)}
        function drawStars(ctx, stars) { if(!ctx)return;ctx.save(); stars.forEach(s=>{ const z=s.size*(0.5+s.z*0.5);const a=0.3+s.z*0.7;ctx.fillStyle=`rgba(255,255,255,${a})`;ctx.beginPath();ctx.arc(s.x,s.y,z,0,Math.PI*2);ctx.fill();}); ctx.restore(); }
        function drawPlanets(ctx, planets) { if(!ctx)return; planets.sort((a,b)=>a.depth-b.depth); planets.forEach(p=>p.draw()); }
        function drawNebulosities(){ if(!ctx) return; ctx.globalCompositeOperation="lighter";ctx.globalAlpha=.6;const oX=Math.sin(game.animationFrame*6e-4)*180,oY=Math.cos(game.animationFrame*7e-4)*120;const dN=(x,y,r,c1,c2,c3)=>{try{const g=ctx.createRadialGradient(x,y,r*.05,x,y,r);g.addColorStop(0,c1);g.addColorStop(.5,c2);g.addColorStop(1,c3);ctx.fillStyle=g;ctx.beginPath();ctx.arc(x,y,r,0,2*Math.PI);ctx.fill()}catch(e){}};dN(canvas.width*.7+oX,canvas.height*.3+oY,320,"rgba(100,0,155,0.06)","rgba(50,0,80,0.04)","rgba(0,0,30,0)");dN(canvas.width*.2-oX,canvas.height*.7-oY,280,"rgba(0,50,155,0.07)","rgba(20,40,120,0.04)","rgba(0,0,30,0)");dN(canvas.width*.8+oX*.5,canvas.height*.8-oY*.7,240,"rgba(155,30,0,0.05)","rgba(100,20,0,0.03)","rgba(30,0,0,0)");dN(canvas.width*.3-oX*.8,canvas.height*.2+oY*.6,200,"rgba(0,155,100,0.04)","rgba(0,100,80,0.02)","rgba(0,30,20,0)");ctx.fillStyle="rgba(200,200,220,0.03)";for(let i=0;i<80;i++){const pX=(pseudoRandom()*1.2*canvas.width-canvas.width*.1+oX*.2)%canvas.width,pY=(pseudoRandom()*1.2*canvas.height-canvas.height*.1+oY*.2)%canvas.height,pS=pseudoRandom()*.8+.2;ctx.fillRect(pX,pY,pS,pS)}ctx.globalCompositeOperation="source-over";ctx.globalAlpha=1;}
        function drawLaserBeam() { if(!spaceship.laserBeamActive||!spaceship.isAlive||!isSpaceshipCurrentlyVisible()||!ctx) return; const beamX=spaceship.x+spaceship.width/2; const beamY0=spaceship.y; const beamY1=0; const beamW=8+Math.sin(game.animationFrame*0.2)*2; ctx.save(); ctx.globalCompositeOperation='lighter'; const grad=ctx.createLinearGradient(beamX,beamY0,beamX,beamY1); try{grad.addColorStop(0,"rgba(255,0,102,0.1)");grad.addColorStop(0.1,"#ff80b3");grad.addColorStop(0.9,"#ff0066");grad.addColorStop(1,"rgba(255,255,255,0.8)");}catch{grad.addColorStop(0,"#ff80b3");grad.addColorStop(1,"#ff0066");} ctx.strokeStyle=grad; ctx.lineWidth=beamW; ctx.lineCap='round'; ctx.beginPath(); ctx.moveTo(beamX,beamY0); ctx.lineTo(beamX,beamY1); ctx.stroke(); ctx.lineWidth=beamW*0.5; try{ctx.strokeStyle=hexToRgba("#ff0066",0.4);}catch{ctx.strokeStyle="rgba(255,150,200,0.4)";} ctx.stroke(); ctx.restore(); }
        function drawBackground() { if(!ctx||!canvas)return;const grad=ctx.createLinearGradient(0,0,0,canvas.height);grad.addColorStop(0,"#000018");grad.addColorStop(.5,"#050520");grad.addColorStop(1,"#000010");ctx.fillStyle=grad;ctx.fillRect(0,0,canvas.width,canvas.height); drawStars(ctx,game.stars); drawNebulosities(); drawPlanets(ctx,game.planets); }
        function drawUIEffects() { if(!ctx)return; if(game.screenFlashTimer>0){const alpha=Math.min(0.6,(game.screenFlashTimer/SCREEN_FLASH_DURATION)*0.6);ctx.fillStyle=`rgba(255,180,180,${alpha})`;ctx.fillRect(0,0,canvas.width,canvas.height);} }
        function drawPauseScreen() { if(pauseOverlay) pauseOverlay.classList.add('visible'); }
        function drawBossHealth() { if(!gameBoss||!gameBoss.active){if(bossHealthBarContainer&&bossHealthBarContainer.style.display!=='none')bossHealthBarContainer.style.display='none';return;} if(bossHealthBarContainer&&bossHealthBarContainer.style.display==='none')bossHealthBarContainer.style.display='block'; gameBoss.updateTotalHealth();}

        // --- Funzioni di Aggiornamento Stato ---
        function updateSpaceship(deltaTime) { if(!spaceship.isAlive)return;const dtS=deltaTime/1000;if(spaceship.invincibleAfterHit){spaceship.hitInvincibleTimer-=deltaTime;if(spaceship.hitInvincibleTimer<=0)spaceship.invincibleAfterHit=false;}if(spaceship.invincibleAfterLifeLoss){spaceship.lifeLossInvincibleTimer-=deltaTime;if(spaceship.lifeLossInvincibleTimer<=0)spaceship.invincibleAfterLifeLoss=false;}if(spaceship.shieldActive){spaceship.shieldTimer-=deltaTime;if(spaceship.shieldTimer<=0){spaceship.shieldActive=false;AudioSystem.playShieldDownSound();updateGameUI(game,spaceship);}}if(spaceship.fireDelay>0)spaceship.fireDelay-=deltaTime;let mX=0,mY=0;if(spaceship.moveLeft)mX-=1;if(spaceship.moveRight)mX+=1;if(spaceship.moveUp)mY-=1;if(spaceship.moveDown)mY+=1;const mag=Math.sqrt(mX*mX+mY*mY);if(mag>0){mX=(mX/mag)*spaceship.speed*dtS;mY=(mY/mag)*spaceship.speed*dtS;}spaceship.x+=mX;spaceship.y+=mY;spaceship.x=Math.max(0,Math.min(canvas.width-spaceship.width,spaceship.x));spaceship.y=Math.max(0,Math.min(canvas.height-spaceship.height,spaceship.y));spaceship.thrustPower=(mX!==0||mY!==0)?1:0; if(spaceship.firing&&spaceship.fireDelay<=0){switch(spaceship.weaponType){case 0:game.playerProjectiles.push(new Projectile(spaceship.x+spaceship.width/2-3,spaceship.y,0));spaceship.fireDelay=spaceship.fireRate;AudioSystem.playLaserSound();break;case 1:const sA=Math.PI/12;game.playerProjectiles.push(new Projectile(spaceship.x+spaceship.width/2-2.5,spaceship.y,1,0));game.playerProjectiles.push(new Projectile(spaceship.x+spaceship.width*0.2,spaceship.y,1,-sA));game.playerProjectiles.push(new Projectile(spaceship.x+spaceship.width*0.8-5,spaceship.y,1,sA));spaceship.fireDelay=spaceship.fireRate*1.4;AudioSystem.playSpreadSound();break;case 2:game.playerProjectiles.push(new Projectile(spaceship.x+spaceship.width/2-2,spaceship.y,2));spaceship.fireDelay=spaceship.fireRate*0.5;AudioSystem.playRapidSound();break;case 3:game.playerProjectiles.push(new Projectile(spaceship.x+spaceship.width/2-5,spaceship.y-10,3));spaceship.fireDelay=spaceship.fireRate*1.8;AudioSystem.playHeavySound();break;case 4:if(!spaceship.laserBeamActive){spaceship.laserBeamActive=true;AudioSystem.startContinuous();}break;}} if(!spaceship.firing&&spaceship.laserBeamActive){spaceship.laserBeamActive=false;AudioSystem.stopContinuous();} if(spaceship.laserBeamActive){const lX=spaceship.x+spaceship.width/2;const lY0=spaceship.y;const lY1=0;const lW=10;const lRect={x:lX-lW/2,y:lY1,width:lW,height:lY0-lY1};game.aliens.forEach(a=>{if(a.active&&isColliding(lRect,a)){const d=LASER_DPS*dtS;if(a.takeDamage(d)){}game.explosions.push(new Explosion(lX,a.y+a.height/2,5+Math.random()*5,{primary:'#ff80b3',energy:'#fff',type:'custom',life:0.1,decay:0.1},'custom'));}});if(gameBoss&&gameBoss.active&&!gameBoss.isEntering){const bRect={x:gameBoss.x-gameBoss.width/2,y:gameBoss.y-gameBoss.height/2,width:gameBoss.width,height:gameBoss.height};if(isColliding(lRect,bRect)){const d=LASER_DPS*dtS;const hY=Math.max(lRect.y,bRect.y+Math.abs(lX-gameBoss.x)*0.1);gameBoss.takeDamage(d,lX,hY);game.explosions.push(new Explosion(lX,hY,8+Math.random()*8,{primary:'#ff80b3',energy:'#fff',type:'custom',life:0.1,decay:0.1},'custom'));}}}}
        function updateProjectiles(projectiles, deltaTime) { for(let i=projectiles.length-1;i>=0;i--){projectiles[i].update(deltaTime);if(!projectiles[i].active)projectiles.splice(i,1);} }
        function updateAliens(deltaTime) { for(let i=game.aliens.length-1;i>=0;i--){if(!game.aliens[i].update(deltaTime))game.aliens.splice(i,1);} }
        function updatePowerUps(deltaTime) { for(let i=game.powerUps.length-1;i>=0;i--){game.powerUps[i].update(deltaTime);if(!game.powerUps[i].active)game.powerUps.splice(i,1);} }
        function updateExplosions(deltaTime) { for(let i=game.explosions.length-1;i>=0;i--){try{if(!game.explosions[i].update(deltaTime))game.explosions.splice(i,1);}catch(e){console.error("Err upd explosion:",e);game.explosions.splice(i,1);}} }
        function updateStars(stars, speed, canvasHeight, deltaTime) { stars.forEach(s=>{s.y+=speed*s.z*deltaTime/16;if(s.y>canvasHeight){s.y=-Math.random()*50;s.x=Math.random()*canvas.width;s.z=Math.random();s.size=1+Math.random()*1.5;}}); }
        function updatePlanets(planets, deltaTime) { for(let i=planets.length-1;i>=0;i--){if(!planets[i].update(deltaTime))planets.splice(i,1);} if(planets.length<MAX_PLANETS&&Math.random()<0.001*(deltaTime/16))spawnPlanet(); }
        function updateBoss(bossInstance, deltaTime) { if(bossInstance&&bossInstance.active)bossInstance.update(deltaTime); }
        function updateUIState(deltaTime) { if(game.uiMessageTimer>0){game.uiMessageTimer-=deltaTime;if(game.uiMessageTimer<=0){uiMessageDisplay.classList.remove('visible');game.uiMessage="";}else if(!uiMessageDisplay.classList.contains('visible')){uiMessageDisplay.textContent=game.uiMessage;uiMessageDisplay.classList.add('visible');}} if(game.screenFlashTimer>0)game.screenFlashTimer-=deltaTime; }
        function updateGameUI(gameData, shipData) { if(scoreValueUI)scoreValueUI.textContent=gameData.score;if(livesValueUI)livesValueUI.textContent=gameData.lives;if(healthValueUI&&healthBarUI){const hT=`${shipData.health}/${shipData.maxHealth}`;healthValueUI.textContent=hT;const hP=(shipData.health/shipData.maxHealth)*100;healthBarUI.style.width=`${hP}%`;if(hP>60)healthBarUI.style.backgroundColor='#40ff40';else if(hP>30)healthBarUI.style.backgroundColor='#ffff40';else healthBarUI.style.backgroundColor='#ff4040';}if(weaponValueUI){let wN="Standard";switch(shipData.weaponType){case 1:wN="Spread";break;case 2:wN="Rapid";break;case 3:wN="Heavy";break;case 4:wN="Laser";break;}weaponValueUI.textContent=wN;}if(levelValueUI)levelValueUI.textContent=gameData.level;if(waveValueUI){if(gameData.bossSpawned)waveValueUI.textContent="BOSS";else if(gameData.allWavesCompleted)waveValueUI.textContent="???";else if(gameData.currentWaveIndex>=0&&gameData.currentWaveIndex<WAVES.length)waveValueUI.textContent=`${gameData.currentWaveIndex+1}/${WAVES.length}`;else waveValueUI.textContent="-";}if(statusValueUI){if(shipData.shieldActive){statusValueUI.textContent="SCUDO";statusValueUI.classList.add('shieldActiveUI');}else if(shipData.invincibleAfterHit||shipData.invincibleAfterLifeLoss){statusValueUI.textContent="INV.";statusValueUI.classList.remove('shieldActiveUI');}else{statusValueUI.textContent="OK";statusValueUI.classList.remove('shieldActiveUI');}}if(enemiesValueUI)enemiesValueUI.textContent=gameData.aliens.filter(a=>a.active).length+(gameBoss&&gameBoss.active?1:0);if(cadetNameDisplayUI)cadetNameDisplayUI.textContent=gameData.cadetName;}

        // --- Gestione Input ---
        function handleKeyDown(event){ if(game.isGameOver)return;if(event.key.toUpperCase()==='P'){togglePause();event.preventDefault();return;}if(!game.running||game.paused)return;let p=true;switch(event.key.toUpperCase()){case"ARROWLEFT":case"A":spaceship.moveLeft=true;break;case"ARROWRIGHT":case"D":spaceship.moveRight=true;break;case"ARROWUP":case"W":spaceship.moveUp=true;break;case"ARROWDOWN":case"S":spaceship.moveDown=true;break;case" ":spaceship.firing=true;break;default:p=false;break;}if(p)event.preventDefault();}
        function handleKeyUp(event){ switch(event.key.toUpperCase()){case"ARROWLEFT":case"A":spaceship.moveLeft=false;break;case"ARROWRIGHT":case"D":spaceship.moveRight=false;break;case"ARROWUP":case"W":spaceship.moveUp=false;break;case"ARROWDOWN":case"S":spaceship.moveDown=false;break;case" ":spaceship.firing=false;break;}}

        // --- Logica High Score ---
        function loadHighScores(){try{const s=localStorage.getItem(HIGH_SCORE_KEY);return s?JSON.parse(s):[];}catch(e){console.error("Err load scores:",e);localStorage.removeItem(HIGH_SCORE_KEY);return[];}}
        function saveHighScore(){const name=playerNameInput.value.trim().toUpperCase();if(name.length<3||name.length>10||!/^[A-Z0-9]+$/.test(name)){alert("Nome non valido (3-10 A-Z, 0-9).");playerNameInput.focus();playerNameInput.select();return;}if(game.currentScoreSubmitted){console.warn("Score già salvato.");return;}AudioSystem.playButtonSound();const scores=loadHighScores();scores.push({name:name,score:game.score,defeatedBoss:game.bossDefeated});scores.sort((a,b)=>b.score-a.score);try{localStorage.setItem(HIGH_SCORE_KEY,JSON.stringify(scores.slice(0,MAX_HIGH_SCORES)));console.log("HS salvato:",{name,score:game.score});game.currentScoreSubmitted=true;highScoreEntryUI.style.display='none';restartButton.style.display='block';saveScoreButton.style.display='none';displayHighScores();}catch(e){console.error("Err save scores:",e);alert("Errore salvataggio score.");}}
        function displayHighScores(){if(!highScoreListUI)return;const scores=loadHighScores();highScoreListUI.innerHTML='';if(scores.length===0){highScoreListUI.innerHTML='<li><span>NESSUN RECORD</span><span></span></li>';}else{scores.forEach((entry,index)=>{const li=document.createElement('li');const nameSpan=document.createElement('span');let dN=String(entry.name||"???").replace(/</g,"<").replace(/>/g,">");if(entry.defeatedBoss)dN+=' <span title="CMDR Scuderi Sconfitto!">🏆</span>';nameSpan.innerHTML=dN;const scoreSpan=document.createElement('span');scoreSpan.textContent=entry.score||0;li.appendChild(nameSpan);li.appendChild(scoreSpan);if(entry.defeatedBoss){li.style.background="linear-gradient(90deg, rgba(255,215,0,0.25) 0%, rgba(255,215,0,0.05) 100%)";li.style.borderLeft="3px solid #ffd700";nameSpan.style.color="#fff";scoreSpan.style.color="#ffffaa";}highScoreListUI.appendChild(li);});}}
        function checkHighScore(score){const scores=loadHighScores();return scores.length<MAX_HIGH_SCORES||score>(scores[scores.length-1]?.score??0);}
        function submitHighScore(){saveHighScore();}

        // --- Funzioni Logica Cristalli (Esagonali) ---
        function createCrystalCollectEffect(x, y, color) { const eC={primary:color.primary,secondary:color.secondary,accent:"#ffffff",glow:color.glow,energy:color.highlight}; game.explosions.push(new Explosion(x,y,25,eC,"small")); }
        function playCrystalCollectSound(type) { AudioSystem.playCrystalSound(type); }
        function spawnCrystalsFromAlien(alien) { let count=0;let types=[];const pwr=alien.size*alien.maxHealth;if(pwr<70){if(Math.random()<0.35){count=1;types=[0];}}else if(pwr<150){const r=Math.random();if(r<0.5){count=1;types=[0];}else if(r<0.7){count=1;types=[1];}}else if(pwr<300){const r=Math.random();if(r<0.3){count=1;types=[1];}else if(r<0.6){count=2;types=[0,0];}else if(r<0.8){count=1;types=[2];}}else{const r=Math.random();if(r<0.3){count=2;types=[1,0];}else if(r<0.6){count=1;types=[2];}else if(r<0.85){count=2;types=[1,1];}else{count=1;types=[3];}}if(alien.isElite&&Math.random()<0.5){count++;types.push(Math.floor(Math.random()*2));}if(!game.crystals)game.crystals=[];for(let i=0;i<count;i++){const oX=(Math.random()-0.5)*alien.size*0.5;const oY=(Math.random()-0.5)*alien.size*0.5;game.crystals.push(new Crystal(alien.x+oX,alien.y+oY,types[i]??0));}}
        function updateCrystals(deltaTime) { if(!game.crystals)return;for(let i=game.crystals.length-1;i>=0;i--){game.crystals[i].update(deltaTime,spaceship);if(!game.crystals[i].active)game.crystals.splice(i,1);}}
        function drawCrystals() { if(!game.crystals||!ctx)return;for(let crystal of game.crystals)crystal.draw(ctx);}
        // --- Fine Funzioni Cristalli ---

        // --- Funzioni Spawn Entità ---
        function createStars() { game.stars=[]; for(let i=0;i<starCount;i++){game.stars.push({x:Math.random()*canvas.width,y:Math.random()*canvas.height,z:Math.random(),size:1+Math.random()*1.5});} }
        function createInitialPlanets() { game.planets=[]; currentPlanetTypes=[]; for(let i=0;i<Math.floor(MAX_PLANETS/2);i++)spawnPlanet(Math.random()*canvas.height); }
        function spawnPlanet(startY=-200) { if(game.planets.length>=MAX_PLANETS)return; let availT=availablePlanetTypes.filter(t=>!currentPlanetTypes.includes(t)); if(availT.length===0)availT=availablePlanetTypes; const type=availT[Math.floor(Math.random()*availT.length)]; currentPlanetTypes.push(type); const depth=0.3+Math.random()*0.7; const size=80+(1-depth)*150; const x=Math.random()*canvas.width; const y=startY-size; game.planets.push(new Planet(x,y,size,type,depth)); }
        function spawnAlien(wave) { if(!wave||!wave.alienTypes||wave.alienTypes.length===0)return;const typeData=wave.alienTypes[Math.floor(Math.random()*wave.alienTypes.length)];const params=typeData.params;const type=typeData.type;const health=params.health*(1+game.level*0.1);const speedY=params.speedY*(1+game.level*0.05);const shootCooldown=Math.max(500,params.shootCooldown/(1+game.level*0.1));const size=(params.sizeMultiplier||1)*(20+Math.random()*15);const x=Math.random()*(canvas.width-size*2)+size;const y=-size-Math.random()*50;const colors=getRandomColor();game.aliens.push(new Alien(x,y,size,colors,params.movement,{...params,health,speedY,shootCooldown})); }
        function spawnPowerUp(x, y) { const r=Math.random();let type;if(r<0.15)type=6;else if(r<0.30)type=5;else if(r<0.50)type=1;else if(r<0.70)type=2;else if(r<0.85)type=3;else type=4;if(game.powerUps.length<4)game.powerUps.push(new PowerUp(x,y,type));}
        function spawnBoss() { if(!gameBoss&&!game.bossSpawned&&!game.bossDefeated){console.log("INFO: Inizio spawn Boss!");gameBoss=new Boss();gameBoss.spawn();}else{console.warn("WARN: Tentativo spawn boss ma è già presente/sconfitto.");} }
        function createBossExplosion(x, y, size) { console.log("INFO: Creazione esplosione finale Boss");const bossColors={primary:"#ff4400",secondary:"#ffaa00",accent:"#ffffff",glow:"#ff6600",energy:"#ffff88"};game.screenFlashTimer=500;for(let i=0;i<5;i++){setTimeout(()=>{if(game.isGameOver)return;const ex=x+(Math.random()-0.5)*size*0.6;const ey=y+(Math.random()-0.5)*size*0.4;const sz=size*(0.8+Math.random()*0.5);game.explosions.push(new Explosion(ex,ey,sz,bossColors,'large'));if(AudioSystem&&i>0)AudioSystem.playExplosionSound('large');},i*300);}setTimeout(()=>{game.explosions.push(new Explosion(x,y,size*1.5,DEFAULT_EXPLOSION_COLORS,'large'));},1500); }

        // --- Funzioni Gestione Stato Gioco ---
        function initializeGame() {
             console.log("INFO: Inizializzazione gioco post-registrazione...");
             if(!assignElements()) return;
             AudioSystem.init(); // Assicura che l'audio sia inizializzato
             window.addEventListener('keydown', handleKeyDown); window.addEventListener('keyup', handleKeyUp); canvas.addEventListener('contextmenu', (e)=>e.preventDefault());
             setupButtonListeners(); loadHighScores(); displayHighScores();
             initCrystalSystem(); // --- CORREZIONE: Chiamata a init cristalli ---
             resetGame(); createStars(); createInitialPlanets(); updateGameUI(game, spaceship);
             if(titleLogoCanvas) drawCondorspaceTitleLogo(titleLogoCanvas); // Disegna logo header
             mainLayout.classList.add('visible'); startButton.style.display='block'; startButton.disabled=false; canvas.focus();
             console.log("INFO: Init gioco completato.");
         }
        function startGame() {
             console.log("INFO: Avvio partita..."); if(game.running&&!game.paused)return;
             AudioSystem.playButtonSound(); // Suono click start
             gameOverOverlay.style.display='none'; startButton.style.display='none'; pauseOverlay.classList.remove('visible');
             resetGame(); AudioSystem.playGameStartSound();
             if(AudioSystem.isInitialized&&AudioSystem.context?.state==='running'){AudioSystem.stopAllMP3Music(200);setTimeout(()=>{if(game.running&&!game.paused&&!game.bossSpawned)AudioSystem.playGameplayMP3();},300);}
             game.running=true; game.paused=false; game.isGameOver=false; game.lastTime=performance.now();
             if(animationFrameId===null){gameLoop(game.lastTime);console.log("INFO: Game loop avviato.");} else {console.log("INFO: Gioco ripreso.");}
             canvas.focus();
        }
        function resetGame() { console.log("INFO: Reset gioco.");game.score=0;game.lives=3;game.level=1;game.currentWaveIndex=-1;game.waveTimer=0;game.timeUntilNextWave=3000;game.inWavePause=true;game.allWavesCompleted=false;game.bossSpawned=false;game.bossDefeated=false;game.alienSpawnTimer=0;game.errorNotified=false;game.playerProjectiles=[];game.aliens=[];game.alienProjectiles=[];game.explosions=[];game.powerUps=[];game.crystals=[];game.currentScoreSubmitted=false; spaceship.x=canvas.width/2-spaceship.width/2;spaceship.y=canvas.height-spaceship.height-20;spaceship.health=spaceship.maxHealth;spaceship.weaponType=0;spaceship.isAlive=true;spaceship.shieldActive=false;spaceship.shieldTimer=0;spaceship.invincibleAfterHit=false;spaceship.invincibleAfterLifeLoss=false;spaceship.hitInvincibleTimer=0;spaceship.lifeLossInvincibleTimer=0;spaceship.laserBeamActive=false;if(AudioSystem)AudioSystem.stopContinuous();gameBoss=null;updateGameUI(game,spaceship);if(bossHealthBarContainer)bossHealthBarContainer.style.display='none';}
        function pauseGame() { if(!game.paused){game.paused=true; if(AudioSystem)AudioSystem.stopContinuous(); console.log("PAUSA"); pauseOverlay.classList.add('visible');} }
        function resumeGame() { if(game.paused){game.paused=false; pauseOverlay.classList.remove('visible'); AudioSystem.resumeContext(()=>{ if(game.bossSpawned&&!game.bossDefeated)AudioSystem.playBossMP3(); else if(game.running&&!game.allWavesCompleted&&!game.isGameOver)AudioSystem.playGameplayMP3(); if(spaceship.firing&&spaceship.weaponType===4&&spaceship.isAlive&&isSpaceshipCurrentlyVisible())AudioSystem.startContinuous(); }); game.lastTime=performance.now(); if(!animationFrameId)gameLoop(game.lastTime); console.log("RIPRESA"); canvas.focus(); } }
        function togglePause() { if(!game.running||game.isGameOver)return; if(game.paused)resumeGame(); else pauseGame(); }
        function gameOver(victory = false) { if(game.isGameOver)return;console.log(`Game Over. Vittoria: ${victory}`);game.isGameOver=true;game.running=false;if(animationFrameId!==null){cancelAnimationFrame(animationFrameId);animationFrameId=null;} if(AudioSystem){if(!victory)AudioSystem.playGameOverSound();AudioSystem.stopContinuous();if(!victory||!game.bossDefeated)AudioSystem.stopAllMP3Music(500);} finalScoreUI.textContent=game.score;gameOverOverlay.style.display='flex';gameOverOverlay.classList.toggle('victory',victory);gameOverOverlay.querySelector('h2').textContent=victory?"VITTORIA!":"FINE PARTITA"; const scores=loadHighScores();const lowestScore=scores.length<MAX_HIGH_SCORES?0:scores[scores.length-1].score; if(game.score>lowestScore){console.log("Nuovo High Score!");highScoreEntryUI.style.display='block';playerNameInput.value='';playerNameInput.focus();game.currentScoreSubmitted=false;saveScoreButton.style.display='block';restartButton.style.display='none';const label=highScoreEntryUI.querySelector('label');if(label){if(victory||game.bossDefeated){label.innerHTML='Vittoria Eroica! Nuovo Record! <span title="CMDR Scuderi Sconfitto!">🏆</span>';}else{label.textContent='Congratulazioni! Nuovo Record!';}}}else{highScoreEntryUI.style.display='none';restartButton.style.display='block';saveScoreButton.style.display='none';game.currentScoreSubmitted=true;} }
        function loseLife() { if(!spaceship.isAlive)return;console.log("Vita persa!");game.lives--;updateGameUI(game,spaceship);game.explosions.push(new Explosion(spaceship.x+spaceship.width/2,spaceship.y+spaceship.height/2,spaceship.width*1.5,{primary:'#ffaa44',secondary:'#ff8800',accent:'#ffffff',glow:'#ff6600',energy:'#ffff88'},'medium'));if(AudioSystem)AudioSystem.playExplosionSound('medium');spaceship.isAlive=false;if(game.lives<=0){setTimeout(()=>gameOver(false),1000);}else{setTimeout(()=>{if(!game.running||game.isGameOver)return;spaceship.x=canvas.width/2-spaceship.width/2;spaceship.y=canvas.height-spaceship.height-20;spaceship.health=spaceship.maxHealth;spaceship.isAlive=true;spaceship.invincibleAfterLifeLoss=true;spaceship.lifeLossInvincibleTimer=spaceship.LIFE_LOSS_INVINCIBILITY_DURATION;spaceship.invincibleAfterHit=false;spaceship.hitInvincibleTimer=0;spaceship.weaponType=0;spaceship.laserBeamActive=false;if(AudioSystem)AudioSystem.stopContinuous();console.log("Respawn.");updateGameUI(game,spaceship);},2000);}}

        // --- Gestione Onde ---
        function updateWaveSystem(deltaTime) { if(game.bossSpawned||game.isGameOver)return;if(game.allWavesCompleted&&!game.inWavePause){if(game.aliens.filter(a=>a.active).length===0){if(!gameBoss&&!game.bossSpawned){console.log("Onde finite, alieni clear. Countdown Boss...");warningBeforeBoss();game.timeUntilNextWave=5000;game.allWavesCompleted=false;game.inWavePause=true;}}return;}if(game.inWavePause){game.timeUntilNextWave-=deltaTime;if(game.timeUntilNextWave<=0){if(!game.allWavesCompleted&&game.currentWaveIndex>=WAVES.length-1){spawnBoss();game.inWavePause=false;}else{startNextWave();}}}else{const wave=WAVES[game.currentWaveIndex];if(!wave)return;game.waveTimer+=deltaTime;game.alienSpawnTimer-=deltaTime;if(game.waveTimer>=wave.duration&&!game.allWavesCompleted){console.log(`Onda ${game.currentWaveIndex+1} durata terminata.`);game.inWavePause=true;game.timeUntilNextWave=wave.pauseAfter||3000;game.alienSpawnTimer=0;updateGameUI(game,spaceship);return;}if(game.alienSpawnTimer<=0&&game.aliens.filter(a=>a.active).length<wave.maxAliensOnScreen){spawnAlien(wave);game.alienSpawnTimer=wave.spawnInterval*(0.85+Math.random()*0.25);}}}
        function startNextWave() { game.currentWaveIndex++;if(game.currentWaveIndex>=WAVES.length){console.log("Tutte le onde finite! Attesa Boss...");game.allWavesCompleted=true;game.inWavePause=true;game.timeUntilNextWave=5000;warningBeforeBoss();}else{const wave=WAVES[game.currentWaveIndex];console.log(`Avvio Onda ${game.currentWaveIndex+1}: ${wave.name}`);game.waveTimer=0;game.timeUntilNextWave=0;game.inWavePause=false;game.level=game.currentWaveIndex+1;game.alienSpawnTimer=wave.spawnInterval*0.5;}updateGameUI(game,spaceship);}
        function warningBeforeBoss() { console.log("Warning: Boss incoming!");let f=0;const mF=5;const fId=setInterval(()=>{if(f>=mF||game.isGameOver||game.bossSpawned){clearInterval(fId);if(canvas)canvas.style.borderColor="#303050";return;}if(canvas)canvas.style.borderColor=f%2===0?"#ff4444":"#303050";game.screenFlashTimer=SCREEN_FLASH_DURATION;f++;if(f===1){game.uiMessage="⚠️ BOSS IN ARRIVO ⚠️";game.uiMessageTimer=UI_MESSAGE_DURATION*2.5;if(uiMessageDisplay)uiMessageDisplay.style.color="#ff4444";}},600); }

        // --- Controllo Collisioni ---
        function checkCollisions(deltaTime) { const dtS=deltaTime/1000; for(let i=game.playerProjectiles.length-1;i>=0;i--){const p=game.playerProjectiles[i];if(!p.active)continue;for(let j=game.aliens.length-1;j>=0;j--){const a=game.aliens[j];if(!a.active)continue;if(isColliding(p,a)){p.active=false;a.takeDamage(p.damage);break;}}} if(gameBoss&&gameBoss.active&&!gameBoss.isEntering){for(let i=game.playerProjectiles.length-1;i>=0;i--){const p=game.playerProjectiles[i];if(!p.active)continue;const bR={x:gameBoss.x-gameBoss.width/2,y:gameBoss.y-gameBoss.height/2,width:gameBoss.width,height:gameBoss.height};if(isColliding(p,bR)){gameBoss.takeDamage(p.damage,p.x+p.width/2,p.y+p.height/2);p.active=false;}}} if(spaceship.laserBeamActive&&spaceship.isAlive&&isSpaceshipCurrentlyVisible()){const lW=12;const lR={x:spaceship.x+spaceship.width/2-lW/2,y:0,width:lW,height:spaceship.y};game.aliens.forEach(a=>{if(a.active&&isColliding(lR,{x:a.x-a.collisionRadius,y:a.y-a.collisionRadius,width:a.collisionRadius*2,height:a.collisionRadius*2})){a.takeDamage(LASER_DPS*dtS);if(game.animationFrame%5===0)a.hitEffects.push({x:(Math.random()-.5)*a.size*.3,y:(Math.random()-.5)*a.size*.3,size:a.size*.2,life:0.5});}});if(gameBoss&&gameBoss.active&&!gameBoss.isEntering){for(const k in gameBoss.components){const c=gameBoss.components[k];if(!c.active||!c.isHittable)continue;const cR={x:gameBoss.x+c.x-c.width/2,y:gameBoss.y+c.y-c.height/2,width:c.width,height:c.height};if(isColliding(lR,cR)){const hX=spaceship.x+spaceship.width/2;const hY=Math.max(cR.y,lR.y);gameBoss.takeDamage(LASER_DPS*dtS,hX,hY);}}}} if(spaceship.isAlive&&!spaceship.shieldActive&&!spaceship.invincibleAfterHit&&!spaceship.invincibleAfterLifeLoss){for(let i=game.alienProjectiles.length-1;i>=0;i--){const ap=game.alienProjectiles[i];if(ap.active&&ap.lifeTimer===null&&isColliding(ap,spaceship)){ap.active=false;spaceship.takeDamage(ap.damage);}}} else if(spaceship.isAlive&&spaceship.shieldActive){const sR=spaceship.width*0.8;const sCX=spaceship.x+spaceship.width/2;const sCY=spaceship.y+spaceship.height/2;for(let i=game.alienProjectiles.length-1;i>=0;i--){const ap=game.alienProjectiles[i];if(!ap.active)continue;const dx=ap.x+ap.width/2-sCX;const dy=ap.y+ap.height/2-sCY;const dSq=dx*dx+dy*dy;if(dSq<(sR+ap.width/2)**2){ap.active=false;game.explosions.push(new Explosion(ap.x,ap.y,15,{primary:"#fff",energy:"#80ffff"},'small'));}}} }

        // --- Game Loop Principale ---
        function gameLoop(currentTime) {
            if (!game.running) { if(animationFrameId) cancelAnimationFrame(animationFrameId); animationFrameId = null; return; }
            if (game.paused) { animationFrameId = requestAnimationFrame(gameLoop); return; }

            if (!game.lastTime) game.lastTime = currentTime; game.deltaTime = currentTime - game.lastTime; game.lastTime = currentTime; if (game.deltaTime > 100) game.deltaTime = 16.67;
            game.animationFrame++;
            if(game.globalAlienFireCooldown>0) game.globalAlienFireCooldown -= game.deltaTime; if(game.screenFlashTimer>0) game.screenFlashTimer -= game.deltaTime;

            // --- Update ---
            updateUIState(game.deltaTime); updateStars(game.stars, starSpeed, canvas.height, game.deltaTime); updatePlanets(game.planets, game.deltaTime); updateSpaceship(game.deltaTime); updateProjectiles(game.playerProjectiles, game.deltaTime); updateAliens(game.deltaTime); updateProjectiles(game.alienProjectiles, game.deltaTime); updatePowerUps(game.deltaTime); updateCrystals(game.deltaTime); updateExplosions(game.deltaTime); updateBoss(gameBoss, game.deltaTime); updateWaveSystem(game.deltaTime);
            // --- Collisions ---
            checkCollisions(game.deltaTime);
            // --- Render ---
            ctx.clearRect(0, 0, canvas.width, canvas.height); drawBackground(); drawCrystals(); drawPowerUps(); drawAliens(); drawProjectiles(game.alienProjectiles); drawSpaceship(); drawLaserBeam(); drawProjectiles(game.playerProjectiles); if(gameBoss && gameBoss.isVisible) gameBoss.draw(ctx); drawExplosions(); drawUIEffects(); drawBossHealth(); updateGameUI(game, spaceship);
            // --- Next Frame ---
            animationFrameId = requestAnimationFrame(gameLoop);
        }

        // --- Funzioni Intro e Flusso Iniziale ---
        function startIntroSequence() {
             console.log("Starting Intro Sequence..."); if(!introOverlay||!mainLayout||!skipIntroButton||!introLogoCanvas){console.error("Intro elements missing.");return;}
             window.introOver=false; window.introAudioPlayed=false; introOverlay.style.opacity='1'; introOverlay.classList.remove('hidden'); introOverlay.style.display='flex';
             drawCondorspaceTitleLogo(introLogoCanvas); mainLayout.classList.remove('visible'); if(startButton)startButton.style.display="none"; if(gameOverOverlay)gameOverOverlay.style.display="none";
             skipIntroButton.removeEventListener('click',handleSkipInteraction); window.removeEventListener('keydown',handleIntroSkipKey); skipIntroButton.addEventListener('click',handleSkipInteraction); window.addEventListener('keydown',handleIntroSkipKey);
             const introDuration=60000; if(window.introTimeout)clearTimeout(window.introTimeout); window.introTimeout=setTimeout(()=>{if(!window.introOver)handleSkipInteraction();},introDuration);
             AudioSystem.init(()=>{if(AudioSystem.context?.state==='running'){console.log("Audio context active, playing intro music.");AudioSystem.playIntroMP3();window.introAudioPlayed=true;}else{console.log("Audio context suspended, intro music will wait.");}});
             const crawlC=document.getElementById('crawlContainer'); if(crawlC)setTimeout(()=>{crawlC.style.opacity='1';},5000);
        }
        function handleSkipInteraction() { if(window.introOver)return; console.log("Intro interaction."); AudioSystem.playButtonSound(); AudioSystem.resumeContext(()=>{if(!window.introAudioPlayed&&AudioSystem.isInitialized&&AudioSystem.context?.state==='running'){console.log("Audio context now running, playing intro music.");AudioSystem.playIntroMP3();window.introAudioPlayed=true;} skipIntroVisuals(); }); }
        function skipIntroVisuals() { if(window.introOver)return;window.introOver=true;console.log("Ending Intro Visuals..."); if(window.introTimeout)clearTimeout(window.introTimeout);window.introTimeout=null; const skipBtn=document.getElementById('skipIntroButton');if(skipBtn)skipBtn.removeEventListener('click',handleSkipInteraction);window.removeEventListener('keydown',handleIntroSkipKey); if(introOverlay){introOverlay.style.opacity='0';introOverlay.classList.add('hidden');} setTimeout(()=>{if(introOverlay)introOverlay.style.display='none'; showCadetRegistration(); },1000); }
        function handleIntroSkipKey(e) { const pNI=document.getElementById('playerNameInput'); if(e.key===" "&&!window.introOver&&(!pNI||document.activeElement!==pNI)){e.preventDefault();handleSkipInteraction();} }

        // --- Funzioni Registrazione Cadetto (Invocano le tue funzioni fornite) ---
        function showCadetRegistration() { console.log("Mostra registrazione cadetto..."); const screen=document.getElementById('cadetRegistrationScreen'); if(screen){screen.classList.add('active'); if(typeof renderCadetRegistration==='function')renderCadetRegistration(); else {console.error("renderCadetRegistration non definita"); completeCadetRegistration("CADETTO");}} else {console.error("Schermata registrazione non trovata!"); completeCadetRegistration("CADETTO");}}
        function completeCadetRegistration(cadetName) { const screen=document.getElementById('cadetRegistrationScreen'); const layout=document.getElementById('mainLayout'); const btn=document.getElementById('startButton'); if(screen)screen.classList.remove('active'); if(layout)layout.classList.add('visible'); if(btn){btn.style.display='block';btn.disabled=false;btn.focus();} console.log("Registrazione completata:",cadetName); if(window.game)game.cadetName=cadetName; updateCadetNameInUI(cadetName); const sub=document.querySelector('#titleHeader h2'); if(sub)sub.textContent="NETHEX CONTRO IL DEMAND GALATTICO"; /* Non fermare musica intro qui */ }
        function updateCadetNameInUI(cadetName) { const sidebar=document.getElementById('uiSidebar'); if(!sidebar)return; let container=document.getElementById('cadetNameContainer'); if(!container){container=document.createElement('div');container.id='cadetNameContainer';container.style.marginTop='15px';container.style.marginBottom='15px';container.style.textAlign='center';container.style.padding='8px 0';container.style.borderTop='1px solid #445566';container.style.borderBottom='1px solid #445566';container.style.backgroundColor='rgba(0,0,0,0.15)'; container.innerHTML=`<div style="color:#aaccff;font-size:0.9em;margin-bottom:3px;text-transform:uppercase;letter-spacing:1px;">PILOTA</div><div id="cadetNameDisplay" style="color:#ffaa44;font-weight:bold;font-size:1.1em;text-shadow:0 0 4px #ffaa44;">${cadetName}</div><div style="color:#aaccff;font-size:0.8em;margin-top:3px;font-style:italic;">STATO MISSIONE</div>`; const header=sidebar.querySelector('h3'); if(header)header.after(container); else sidebar.prepend(container); } else {const display=document.getElementById('cadetNameDisplay');if(display)display.textContent=cadetName;} }

        // --- CORREZIONE: Funzioni di registrazione fornite da te ---
        function renderCadetRegistration() { console.log("Rendering cadet registration UI...");const container=document.getElementById('cadetRegistrationContainer');if(!container){console.error("Container registrazione cadetto non trovato");return;}let cadetName='';let isSubmitting=false;container.innerHTML=`<div style="display:flex;flex-direction:column;align-items:center;background:#0f0f1e;padding:20px;border-radius:10px;border:1px solid #49daff;box-shadow:0 0 30px rgba(73,218,255,0.4);"><canvas id="cadetCanvas" width="500" height="300" style="margin-bottom:20px;border-radius:5px;"></canvas><div style="display:flex;align-items:center;width:80%;margin-bottom:20px;"><input type="text" id="cadetNameInputReg" placeholder="Inserisci il tuo nome, Cadetto" style="flex:1;padding:10px;background:#0a0a2a;color:#49daff;border:2px solid #49daff;border-radius:4px;font-size:16px;font-family:'VT323',monospace;" maxlength="10" minlength="3"><button id="submitCadetButton" style="margin-left:10px;padding:10px 20px;background:#49daff;color:#000;border:none;border-radius:4px;font-weight:normal;cursor:pointer;font-family:'VT323',monospace;text-transform:uppercase;letter-spacing:1px;" disabled>CONFERMA</button></div><p style="color:#bbb;font-size:14px;text-align:center;line-height:1.4;">Identificati, pilota.<br>Il tuo nome verrà inciso negli annali del Demand.</p></div>`;drawCadetRegistrationCanvas();const inputField=document.getElementById('cadetNameInputReg');const confirmButton=document.getElementById('submitCadetButton');if(!inputField||!confirmButton){console.error("Elementi UI registrazione mancanti");return;}const updateSubmitState=()=>{if(isSubmitting){confirmButton.disabled=true;confirmButton.textContent='REGISTRAZIONE...';confirmButton.style.background='#274b5d';confirmButton.style.color='#aaa';confirmButton.style.cursor='wait';}else if(cadetName.length<3){confirmButton.disabled=true;confirmButton.textContent='CONFERMA';confirmButton.style.background='#274b5d';confirmButton.style.color='#aaa';confirmButton.style.cursor='not-allowed';}else{confirmButton.disabled=false;confirmButton.textContent='CONFERMA';confirmButton.style.background='#49daff';confirmButton.style.color='#000';confirmButton.style.cursor='pointer';}};const handleCadetSubmit=()=>{if(cadetName.length<3||isSubmitting)return;console.log("Invio registrazione:",cadetName);isSubmitting=true;updateSubmitState();AudioSystem.playButtonSound();AudioSystem.play('gameStart');setTimeout(()=>{isSubmitting=false;updateSubmitState();completeCadetRegistration(cadetName);},1000);};inputField.addEventListener('input',(e)=>{cadetName=e.target.value.trim().toUpperCase();e.target.value=cadetName;updateSubmitState();});inputField.addEventListener('keyup',(e)=>{if(e.key==='Enter'&&!isSubmitting&&cadetName.length>=3)handleCadetSubmit();});confirmButton.addEventListener('click',handleCadetSubmit);updateSubmitState();setTimeout(()=>{if(inputField)inputField.focus();},100); }
        function drawCadetRegistrationCanvas() { const canvasReg=document.getElementById('cadetCanvas');if(!canvasReg)return;const ctxReg=canvasReg.getContext('2d');if(!ctxReg)return;const w=canvasReg.width;const h=canvasReg.height;const bgG=ctxReg.createLinearGradient(0,0,0,h);bgG.addColorStop(0,'#0c1445');bgG.addColorStop(1,'#0a0a20');ctxReg.fillStyle=bgG;ctxReg.fillRect(0,0,w,h);for(let i=0;i<150;i++){const x=Math.random()*w;const y=Math.random()*h;const r=Math.random()*1.5;const o=Math.random()*0.8+0.2;ctxReg.beginPath();ctxReg.arc(x,y,r,0,Math.PI*2);ctxReg.fillStyle=`rgba(255,255,255,${o})`;ctxReg.fill();}ctxReg.strokeStyle='#49daff';ctxReg.lineWidth=3;ctxReg.shadowColor='#49daff';ctxReg.shadowBlur=10;ctxReg.strokeRect(20,20,w-40,h-40);ctxReg.shadowBlur=0;ctxReg.lineWidth=5;const cs=20;ctxReg.beginPath();ctxReg.moveTo(20,40);ctxReg.lineTo(20,20);ctxReg.lineTo(40,20);ctxReg.stroke();ctxReg.beginPath();ctxReg.moveTo(w-40,20);ctxReg.lineTo(w-20,20);ctxReg.lineTo(w-20,40);ctxReg.stroke();ctxReg.beginPath();ctxReg.moveTo(20,h-40);ctxReg.lineTo(20,h-20);ctxReg.lineTo(40,h-20);ctxReg.stroke();ctxReg.beginPath();ctxReg.moveTo(w-40,h-20);ctxReg.lineTo(w-20,h-20);ctxReg.lineTo(w-20,h-40);ctxReg.stroke();ctxReg.shadowColor='#49daff';ctxReg.shadowBlur=5;ctxReg.font='bold 24px VT323';ctxReg.fillStyle='#49daff';ctxReg.textAlign='center';ctxReg.fillText('REGISTRAZIONE NUOVA RECLUTA',w/2,60);ctxReg.shadowBlur=0; drawCondorspaceTitleLogo({getContext:()=>ctxReg,width:w*0.3,height:h*0.4,getBoundingClientRect:()=>({width:w*0.3,height:h*0.4})}); } // Chiamata a draw logo
        function initCrystalSystem() { console.log("Inizializzazione sistema di cristalli..."); if (!game.crystals) game.crystals=[]; const originalTakeDamageFn=Alien.prototype.takeDamage; if(originalTakeDamageFn&&!originalTakeDamageFn.isPatchedForCrystals){Alien.prototype.takeDamage=function(amount){const wasDestroyed=originalTakeDamageFn.call(this,amount);if(wasDestroyed)spawnCrystalsFromAlien(this);return wasDestroyed;};Alien.prototype.takeDamage.isPatchedForCrystals=true;} console.log("Sistema di cristalli inizializzato!");}


        // --- Setup Iniziale e Listener DOMContentLoaded ---
        function initialize() {
             console.log("INFO: Initializing CONDORSPACE V2.11.3...");
             if (!assignElements()) { console.error("FATAL: Initialization failed: DOM elements missing."); return; }
             AudioSystem.init(() => { // Inizializza audio ma non attendere resume qui
                 console.log("INFO: Audio system initialized (state: " + AudioSystem.context?.state + ").");
                 displayHighScores();
                 drawCondorspaceTitleLogo(titleLogoCanvas); // Disegna logo statico header
                 setupButtonListeners();
                 initCrystalSystem(); // Inizializza sistema cristalli DOPO che le classi sono definite
                 createStars(); createInitialPlanets();
                 if(ctx && canvas) drawBackground(); // Disegna sfondo iniziale
                 // Non chiamare startIntroSequence qui, verrà chiamata da un bottone/interazione iniziale
                 console.log("INFO: Core initialization complete. Waiting for user interaction to start intro.");
                 // --- CORREZIONE: Mostra un pulsante "START SYSTEM" iniziale ---
                 const systemStartButton = document.createElement('button');
                 systemStartButton.id = 'systemStartButton';
                 systemStartButton.textContent = 'AVVIA SISTEMA';
                 systemStartButton.style.position = 'fixed';
                 systemStartButton.style.top = '50%';
                 systemStartButton.style.left = '50%';
                 systemStartButton.style.transform = 'translate(-50%, -50%)';
                 systemStartButton.style.padding = '20px 40px';
                 systemStartButton.style.fontSize = '2em';
                 systemStartButton.style.fontFamily = "'VT323', monospace";
                 systemStartButton.style.background = 'transparent';
                 systemStartButton.style.color = '#49daff';
                 systemStartButton.style.border = '2px solid #49daff';
                 systemStartButton.style.cursor = 'pointer';
                 systemStartButton.style.zIndex = '10000';
                 systemStartButton.onmouseover = () => { systemStartButton.style.backgroundColor = 'rgba(73, 218, 255, 0.1)'; systemStartButton.style.boxShadow = '0 0 15px #49daff'; };
                 systemStartButton.onmouseout = () => { systemStartButton.style.backgroundColor = 'transparent'; systemStartButton.style.boxShadow = 'none'; };
                 systemStartButton.onclick = () => {
                     AudioSystem.playButtonSound();
                     AudioSystem.resumeContext(() => { // Assicura che l'audio sia attivo
                          systemStartButton.remove(); // Rimuovi questo pulsante
                          startIntroSequence(); // Avvia l'intro
                     });
                 };
                 document.body.appendChild(systemStartButton);
             });
             addGameEventListeners();
        }
        function setupButtonListeners() {
             if(startButton){startButton.onclick=()=>{if(startButton.disabled)return;startButton.disabled=true;startButton.textContent="Avvio...";AudioSystem.playButtonSound();AudioSystem.resumeContext(()=>{startGame();});};}else{console.error("Start Button missing!");}
             if(restartButton){restartButton.onclick=()=>{if(!gameOverOverlay||gameOverOverlay.style.display==='none')return;AudioSystem.playButtonSound();gameOverOverlay.style.display="none";if(mainLayout)mainLayout.classList.add('visible');if(ctx&&canvas){ctx.fillStyle="#050510";ctx.fillRect(0,0,canvas.width,canvas.height);ctx.fillStyle="#aaccff";ctx.textAlign="center";ctx.font="20px VT323";ctx.fillText("Riavvio...",canvas.width/2,canvas.height/2);ctx.textAlign="left";}startGame(true);};}else{console.error("Restart Button missing!");}
             if(saveScoreButton){saveScoreButton.onclick=()=>{AudioSystem.playButtonSound();submitHighScore();};}else{console.error("Save Score Button missing!");}
             if(playerNameInput){playerNameInput.onkeyup=(e)=>{if(e.key==="Enter")submitHighScore();};}else{console.error("Player Name Input missing!");}
        }
        function addGameEventListeners() { window.addEventListener('keydown',handleKeyDown);window.addEventListener('keyup',handleKeyUp);window.addEventListener('keydown',function(e){if(e.key===" "&&document.activeElement!==playerNameInput&&(!game.running||game.paused)&&!window.introOver)e.preventDefault();});window.addEventListener('blur',()=>{if(game.running&&!game.paused&&!game.isGameOver)pauseGame();});window.addEventListener('error',e=>{console.error("Unhandled error:",e.message,e.filename,e.lineno);if(!game.errorNotified)game.errorNotified=true;}); }

        // --- Avvio Inizializzazione ---
        document.addEventListener('DOMContentLoaded', initialize);

    </script>
    <!-- === FINE BLOCCO 6 === -->
    <!-- === INSERISCI QUI IL BLOCCO 7 (HTML Closing Tags) === -->


          <!-- === INIZIO BLOCCO 7 (HTML Closing Tags) === -->
</body>
</html>
    <!-- === FINE BLOCCO 7 === -->
    <!-- === FINE DEL FILE === -->
